var re=Object.defineProperty;var ie=(t,e,o)=>e in t?re(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var C=(t,e,o)=>ie(t,typeof e!="symbol"?e+"":e,o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=o(r);fetch(r.href,i)}})();const h=(t,e)=>{const o=document.createElement(t);return Object.keys(e).forEach(n=>{o.setAttribute(n,e[n])}),o},y="http://127.0.0.1:3030/assets/",a={currentNode:null,nodes:[],observer:{currentNode:null,currentHoverNode:null},currentHoverNode:null,borderInfo:{},currentDragEnterNode:null,displayInfo:{},insertPosition:"none",excludeTags:["script","style","meta","link"],hoverTipContainer:h("div",{system:"1",style:"pointer-events: none; position: absolute;"}),selectedTipContainer:h("div",{system:"1",style:"pointer-events: none; position: absolute;"}),operationContainer:h("div",{system:"1",class:"flex",style:"position: absolute; gap: 5px; padding: 5px; background-color: #38bdf8; cursor: pointer; "}),hoverNodeNameTipContainer:h("div",{system:"1",style:"padding-left: 10px; padding-right: 10px; background-color: #38bdf8; color: white; pointer-events: none; position: absolute;"}),selectedNodeNameTipContainer:h("div",{system:"1",style:"padding-left: 10px; padding-right: 10px; background-color: #f87171; color: white; pointer-events: none; position: absolute; z-index: 1000;"}),dragLine:h("div",{system:"1",style:"position: fixed; left: 0; top: 0; pointer-events: none; background-color: #f87171;"}),menu:[{icon:y+"icons/up.png",key:"up",element:h("div",{system:"1"})},{icon:y+"icons/down.png",key:"down",element:h("div",{system:"1"})},{icon:y+"icons/underline.png",key:"underline",element:h("div",{system:"1"})},{icon:y+"icons/italic.png",key:"italic",element:h("div",{system:"1"})},{icon:y+"icons/bold.png",key:"bold",element:h("div",{system:"1"})},{icon:y+"icons/strikethrough.png",key:"strikethrough",element:h("div",{system:"1"})},{icon:y+"icons/drag.png",key:"drag",element:h("div",{system:"1"})},{icon:y+"icons/copy.png",key:"copy",element:h("div",{system:"1"})},{icon:y+"icons/translate.png",key:"translate",element:h("div",{system:"1"})},{icon:y+"icons/export.png",key:"export",element:h("div",{system:"1"})},{icon:y+"icons/delete.png",key:"delete",element:h("div",{system:"1"})}],markedNodes:new Map,markedList:[],topParent:null};function l(t,e){window.parent.postMessage({type:t,data:e},"*")}function x(){l("hacker-un-save",{})}function R(){a.hoverTipContainer.style.display="none",a.selectedTipContainer.style.display="none",a.hoverNodeNameTipContainer.style.display="none",a.selectedNodeNameTipContainer.style.display="none",a.dragLine.style.display="none",a.operationContainer.style.opacity="0"}function U(){a.hoverTipContainer.style.display="none",a.hoverNodeNameTipContainer.style.display="none",a.operationContainer.style.display="none"}function ae(t){const e=getComputedStyle(t),o=i=>i.replace(/-([a-z])/g,(c,s)=>s.toUpperCase()),n={};for(let i of e){const c=o(i);n[c]=e.getPropertyValue(i)}const r={...n,hackerId:t.getAttribute("hacker-id"),hackerMark:t.getAttribute("data-hacker-mark")||!1,id:t.getAttribute("id"),src:t.getAttribute("src"),href:t.getAttribute("href"),target:t.getAttribute("data-target")||"none",placeholder:t.getAttribute("placeholder"),name:t.getAttribute("name"),type:t.getAttribute("type"),classList:t.className,hoverClass:t.getAttribute("data-hover-class")||"",disabledClass:t.getAttribute("data-disabled-class")||"",classType:typeof t.className,tagName:t.tagName.toLowerCase(),height:t.style.height||t.offsetHeight,width:t.style.width||t.offsetWidth,text:t.innerText,srcset:t.getAttribute("srcset"),borderRadius:e.borderRadius,borderStyle:e.borderStyle,borderWidth:e.borderWidth,borderColor:e.borderColor,backgroundColor:e.backgroundColor,triggerTiming:t.getAttribute("data-trigger-timing")||"none",triggerType:t.getAttribute("data-trigger-type")||"system",triggerCode:t.getAttribute("data-trigger-code")||"",triggerEvent:t.getAttribute("data-trigger-event")||"none",targetState:t.getAttribute("data-target-state")||"default",targetId:t.getAttribute("data-target-id")||"",targetLink:t.getAttribute("data-target-link")||"",macroId:t.getAttribute("data-macro-id")||"",macroValue:t.getAttribute("data-macro-value")||"",disabled:t.getAttribute("data-disabled")||"false"};if((t.tagName.toLowerCase()==="input"||t.tagName.toLowerCase()==="textarea")&&Object.assign(r,{sensitive:t.getAttribute("data-sensitive")||"",alias:t.getAttribute("data-alias")||t.getAttribute("name"),mode:t.getAttribute("data-mode")||"system",rule:t.getAttribute("data-rule")||"none",msg:t.getAttribute("data-msg")||"",required:t.getAttribute("required")||"false",user:t.getAttribute("data-user")||"",minLength:t.getAttribute("minlength")||"",maxLength:t.getAttribute("maxlength")||""}),t.tagName.toLowerCase()==="select"){const i=t,c=Array.from(i.options).map(s=>({value:s.value,text:s.text,selected:s.selected}));Object.assign(r,{options:c,user:i.getAttribute("data-user")||"",sensitive:i.getAttribute("data-sensitive")||"",alias:i.getAttribute("data-alias")||i.getAttribute("name")})}l("hacker-node-info",r)}const g=[];for(let t=0;t<256;++t)g.push((t+256).toString(16).slice(1));function se(t,e=0){return(g[t[e+0]]+g[t[e+1]]+g[t[e+2]]+g[t[e+3]]+"-"+g[t[e+4]]+g[t[e+5]]+"-"+g[t[e+6]]+g[t[e+7]]+"-"+g[t[e+8]]+g[t[e+9]]+"-"+g[t[e+10]]+g[t[e+11]]+g[t[e+12]]+g[t[e+13]]+g[t[e+14]]+g[t[e+15]]).toLowerCase()}let L;const ce=new Uint8Array(16);function le(){if(!L){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");L=crypto.getRandomValues.bind(crypto)}return L(ce)}const de=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),z={randomUUID:de};function N(t,e,o){var r;if(z.randomUUID&&!t)return z.randomUUID();t=t||{};const n=t.random??((r=t.rng)==null?void 0:r.call(t))??le();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,se(n)}function Y(t,e,o=4,n=4){const{top:r,left:i,width:c,height:s}=t;e.style.top=`${r-o+window.scrollY}px`,e.style.left=`${i-n+window.scrollX}px`,e.style.width=`${c+n*2}px`,e.style.height=`${s+o*2}px`}function K(t,e,o,n=2,r=2){t.innerText=e,t.style.display="block",t.style.left=`${o.left+n+window.scrollX}px`,t.style.top=`${o.top-t.offsetHeight+r+window.scrollY}px`}function E(t){const e=t.target;a.currentHoverNode=e,a.observer.currentHoverNode=e;const o=e.getBoundingClientRect(),n=a.hoverTipContainer;n.style.display="block",Y(o,n,2,2),n.style.border="1px dashed #38bdf8";const r=e.tagName.toLowerCase();K(a.hoverNodeNameTipContainer,r,o,-2,-2)}function M(t){t.stopPropagation()}function ue(){a.hoverTipContainer.style.zIndex="99999",a.hoverNodeNameTipContainer.style.zIndex="99999",document.body.appendChild(a.hoverTipContainer),document.body.appendChild(a.hoverNodeNameTipContainer),a.nodes.forEach(t=>{t.addEventListener("mouseenter",E),t.addEventListener("mouseleave",M),t.style.userSelect="none"})}function w(t){const e=t.target;if(e.getAttribute("system")=="1"||a.excludeTags.includes(e.tagName.toLowerCase()))return;a.currentNode!==null&&a.currentNode!==e&&a.currentNode.setAttribute("contenteditable","false"),a.currentNode=e,a.currentNode.tagName.toLowerCase()!="img"&&a.currentNode.setAttribute("contenteditable","true");const o=e.getBoundingClientRect();a.currentHoverNode===e&&E(t),pe(o),a.selectedTipContainer.style.border="2px dashed #f87171",a.selectedTipContainer.style.display="block",Y(o,a.selectedTipContainer,2,2),K(a.selectedNodeNameTipContainer,e.tagName.toLowerCase(),o,-2,-2),x(),ae(e),(e.closest("a")||e.closest("select"))&&t.preventDefault()}function pe(t){const e=a.operationContainer;e.style.display="flex",e.style.opacity="1",e.style.zIndex="999999999",e.style.left=`${t.left+window.scrollX}px`,e.style.top=`${t.bottom+window.scrollY}px`;const o=e.offsetWidth,n=e.offsetHeight,r=window.innerWidth,i=window.innerHeight;e.offsetLeft+o>r&&(e.style.left=`${r-o}px`),Math.ceil(t.top+t.height)>=i&&(e.style.top=`${i-n+window.scrollY}px`)}function he(){a.selectedTipContainer.style.zIndex="99999",document.body.appendChild(a.selectedTipContainer),document.body.appendChild(a.selectedNodeNameTipContainer),a.nodes.forEach(t=>{t.addEventListener("click",w),t.tagName.toLocaleLowerCase()=="select"&&t.addEventListener("mousedown",e=>e.preventDefault()),t.style.userSelect="none"}),a.menu.forEach(t=>{t.key!=="drag"&&(t.element.onclick=e=>Te(t.key,null))})}function V(t){t.setAttribute("hacker-id",N()),a.nodes.push(t),t.onmouseleave=M,t.onclick=w,t.onmouseenter=E,l("update",{})}function ge(){}const fe=["script","style","noscript","meta","link","head"];function _(t){return t.split("-").map((e,o)=>o===0?e:e.charAt(0).toUpperCase()+e.slice(1)).join("")}function G(t,e){const o=r=>{r.shadowRoot&&n(r,r.shadowRoot),r.setAttribute("shadow","1"),r.onclick=i=>{i.preventDefault(),a.currentNode=r},r.setAttribute("hacker-id",N()),a.nodes.push(r),a.borderInfo[r.getAttribute("hacker-id")]=getComputedStyle(r).border;for(let i=0;i<r.children.length;i++)o(r.children[i])},n=(r,i)=>{for(let c=0;c<i.children.length;c++){const s=i.children[c];o(s)}r.addEventListener("scroll",ge)};n(t,e)}function O(t){const e=[],o=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,J);for(;o.nextNode();){const r=o.currentNode.nodeValue;r&&r.trim()&&e.push(r)}return e}const J={acceptNode(t){var e;return(e=t.parentElement)!=null&&e.tagName.match(/^(SCRIPT|STYLE|CODE)$/i)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}};function T(t=!1){const e=document.documentElement.cloneNode(!0);return e.querySelectorAll('[system="1"]').forEach(o=>{o.remove()}),t&&e.querySelectorAll('[kernel="inject"]').forEach(o=>{o.remove()}),e.outerHTML}const ye=t=>{t.addEventListener("click",w),t.addEventListener("mouseenter",E),t.addEventListener("mouseleave",M),t.setAttribute("hacker-id",N()),a.nodes.push(t)},Z=t=>{const e=[];return Array.from(t.children).forEach(n=>{n instanceof HTMLElement&&(e.push(n),e.push(...Z(n)))}),e},I=t=>{const e=document.body;if(!e)return console.error("未找到指定的容器元素"),null;function o(r,i=0,c="0"){if(!r||r.nodeType===Node.COMMENT_NODE||r.nodeType===Node.TEXT_NODE||r.tagName.toLowerCase()==="noscript"||r.attributes===void 0||r.getAttribute("operation")!==null||r.getAttribute("tools")!==null||fe.includes(r.tagName.toLowerCase()))return null;const s={title:r.tagName?r.tagName.toLowerCase():null,attributes:{},children:[],key:c,content:null,hackerId:r.getAttribute("hacker-id")||null};if(r.nodeType===Node.ELEMENT_NODE){for(const p of r.attributes);r.shadowRoot&&Array.from(r.shadowRoot.children).forEach((m,v)=>{const b=o(m,i+1,`${c}-shadow-${v}`);b&&s.children.push(b)})}let d=0;for(const p of r.childNodes){const m=o(p,i+1,`${c}-${d}`);m&&(s.children.push(m),d++)}return r.textContent&&r.textContent.trim()&&s.children.length,s}const n=o(e);l("hacker-layer",n)};function j(t){try{const e=t.querySelectorAll("script");console.log("尝试执行脚本...: ",e),e.forEach(o=>{try{new Function(o.textContent??"")()}catch(n){console.error("执行脚本失败:",n)}})}catch(e){console.error(e)}}function me(t){const e=be(t),o=new Set(e);if(a.markedNodes.has(t)){const i=a.markedNodes.get(t);i&&(i.remove(),a.markedNodes.delete(t)),o.forEach(c=>{c.removeAttribute("data-marked"),a.markedNodes.delete(c)});return}const n=h("div",{style:"position: absolute; z-index: 9999; pointer-events: none; border: 2px dashed green; border-radius: 5px;"}),r=t.getBoundingClientRect();n.style.top=`${r.top+window.scrollY}px`,n.style.left=`${r.left+window.scrollX}px`,n.style.width=`${r.width}px`,n.style.height=`${r.height}px`,a.markedNodes.set(t,n),document.body.appendChild(n),o.forEach(i=>{i.setAttribute("data-marked","true")})}function be(t,e=!1){if(!(t instanceof HTMLElement))throw new Error("输入参数必须是 HTMLElement 类型");const o=new Set([t]);let n=t.parentElement,r=t;for(;n&&(e?n!==document.documentElement:n!==document.body);)o.add(n),r=n,n=n.parentElement;const i=c=>{Array.from(c.children).forEach(d=>{d instanceof HTMLElement&&(o.add(d),i(d))})};if(i(r),a.topParent===null)a.topParent=r;else{const c=a.topParent.getBoundingClientRect();r.getBoundingClientRect().top<c.top&&(a.topParent=r)}return o}function ke(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`);e&&(a.nodes=a.nodes.filter(o=>o!==e),e.remove())}function Ne(t){const e=t.operation.meta.redo,o=e.node,n=document.querySelector(`[hacker-id="${e.parentNodeId}"]`),r=document.querySelector(`[hacker-id="${e.nextSiblingId}"]`);r?n.insertBefore(o,r):n.appendChild(o),f.push(t)}function Se(t){const e=t.operation.meta.undo,o=e.single,n=document.querySelector(`[hacker-id="${e.parentNodeId}"]`);if(o)n.appendChild(e.node);else{const r=e.nextSiblingId,i=e.previousSiblingId,c=document.querySelector(`[hacker-id="${r}"]`),s=document.querySelector(`[hacker-id="${i}"]`);c?n.insertBefore(e.node,c):s&&s.nextElementSibling?n.insertBefore(e.node,s.nextElementSibling):n.appendChild(e.node)}}function xe(t){const o=t.operation.meta.redo.nodeId,n=document.querySelector(`[hacker-id="${o}"]`);n&&(n.click(),B.delete())}function ve(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.undo,n=document.querySelector(`[hacker-id="${o.parentNodeId}"]`);if(o.single)n.appendChild(e);else{const r=o.nextSiblingId,i=o.previousSiblingId,c=document.querySelector(`[hacker-id="${r}"]`),s=document.querySelector(`[hacker-id="${i}"]`);c?n.insertBefore(e,c):s&&s.nextElementSibling?n.insertBefore(e,s.nextElementSibling):n.appendChild(e)}}function Ce(t){const e=t.operation.meta.redo,o=document.querySelector(`[hacker-id="${e.parentNodeId}"]`),n=document.querySelector(`[hacker-id="${t.hackerId}"]`);if(e.single)o.appendChild(n);else{const r=e.nextSiblingId,i=e.previousSiblingId,c=document.querySelector(`[hacker-id="${r}"]`),s=document.querySelector(`[hacker-id="${i}"]`);c?o.insertBefore(n,c):s&&s.nextElementSibling?o.insertBefore(n,s.nextElementSibling):o.appendChild(n)}f.push(t)}function Ee(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.undo;e?o.position==="replace"?e.replaceWith(o.originNode):o.componentNode.remove():l("hacker-notify","节点丢失，本次操作失败")}function we(t){const e=t.operation.meta.redo,o=document.querySelector(`[hacker-id="${e.parentNodeId}"]`);if(o){const n=e.componentNode,r=e.position,i=document.querySelector(`[hacker-id="${e.originalNodeId}"]`);if(e.originalNode=i.cloneNode(!0),e.componentNode=n.cloneNode(!0),r==="replace")i.replaceWith(n);else if(r==="before")o.insertBefore(n,i);else if(r==="after")o.insertBefore(n,i.nextSibling);else{l("hacker-notify","未定义的操作");return}t.operation.meta.redo={...e},t.operation.meta.undo.componentNode=n,f.push(t)}else l("hacker-notify","父节点丢失，本次操作失败")}function Ae(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.undo;Object.keys(o).forEach(n=>{e.style[n]=o[n]})}function Ie(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.redo;Object.keys(o).forEach(n=>{e.style[n]=o[n]})}const S=class S{constructor(){C(this,"undoStack",[]);C(this,"redoStack",[]);C(this,"maxStackSize",100)}static get Instance(){return S.instance||(S.instance=new S),S.instance}push(e){this.undoStack.length>=this.maxStackSize&&this.undoStack.shift(),this.undoStack.push(e)}pop(e){const o=e==="undo"?this.undoStack:this.redoStack;if(o.length>0){const n=o.pop();return e==="undo"&&this.redoStack.push(n),n}return null}redo(){const e=this.pop("redo");if(e){switch(e.operation.type){case"style":Ie(e);break;case"delete":xe(e);break;case"move":Ce(e);break;case"copy":Ne(e);break;case"spawn":we(e);break;default:l("hacker-notify","editor.redo.not-supported");break}I()}else l("hacker-notify","editor.redo.none")}undo(){const e=this.pop("undo");if(e){switch(e.operation.type){case"style":Ae(e);break;case"delete":Se(e);break;case"move":ve(e);break;case"copy":ke(e);break;case"spawn":Ee(e);break;default:l("hacker-notify","editor.undo.not-supported");break}I()}else l("hacker-notify","editor.undo.none")}};C(S,"instance");let D=S;const f=D.Instance;function k(t,e,o){return{hackerId:t,operation:{type:e,meta:{undo:{},redo:{},...o}}}}class Le{constructor(){C(this,"metaOrCtrlIsPressed",!1);window.addEventListener("keyup",e=>{(e.key==="Meta"||e.key==="Control")&&(this.metaOrCtrlIsPressed=!1)}),window.addEventListener("keydown",e=>{switch((e.key==="Meta"||e.key==="Control")&&(this.metaOrCtrlIsPressed=!0),e.key){case"ArrowUp":this.up();break;case"ArrowDown":this.down();break;case"Delete":this.delete();break;case"Backspace":{this.metaOrCtrlIsPressed&&this.delete();break}case"z":this.metaOrCtrlIsPressed&&f.undo();break}})}callMethod(e,o){typeof this[e]=="function"?this[e](o):console.warn(`Method ${e} is not defined.`)}copy(){const e=a.currentNode;e.removeAttribute("contenteditable");const o=e.cloneNode(!0);o.setAttribute("contenteditable","false");const n=e.parentElement;if(n){let r=e.nextElementSibling;r?n.insertBefore(o,e.nextSibling):n.appendChild(o),a.currentNode=o,V(o);const i=k(o.getAttribute("hacker-id"),"copy",{undo:{}});o.click(),r=o.nextElementSibling,l("update",{}),Z(o).forEach(c=>{V(c)}),i.operation.meta.redo={node:o.cloneNode(!0),parentNodeId:n.getAttribute("hacker-id"),nextSiblingId:r?r.getAttribute("hacker-id"):null},f.push(i)}else l("hacker-notify","无法复制节点，因为当前节点没有父节点")}delete(){const e=a.currentNode;if(e.tagName.toLowerCase()==="body"||e===document.body||e.tagName.toLowerCase()==="html"){l("hacker-notify","无法删除根节点");return}const o=e.parentElement,n=e.nextElementSibling,r=e.previousElementSibling,i=k(e.getAttribute("hacker-id"),"delete",{undo:{node:e.cloneNode(!0),parentNodeId:o.getAttribute("hacker-id"),nextSiblingId:n?n.getAttribute("hacker-id"):null,previousSiblingId:r?r.getAttribute("hacker-id"):null,single:n===null&&r===null}});a.nodes=a.nodes.filter(c=>c!==e),e.remove(),a.currentNode=null,l("update",{}),l("clearNodeInfo",{}),x(),R(),i.operation.meta.redo={nodeId:i.hackerId},console.log("delete state: ",i),f.push(i)}up(){const o=a.currentNode.parentNode;o&&o.click()}down(){const e=a.currentNode;if(!e)return;const o=Array.from(e.children);o.length>0&&(a.currentNode=o[0],a.currentNode.click())}underline(){const e=a.currentNode;if(!e)return;const o=e.style.textDecoration,n=k(e.getAttribute("hacker-id"),"style",{undo:{textDecoration:o}});o==="none"||o===""?e.style.textDecoration="underline":e.style.textDecoration="none",n.operation.meta.redo.textDecoration=e.style.textDecoration,f.push(n)}bold(){const e=a.currentNode;if(!e)return;const o=k(e.getAttribute("hacker-id"),"style",{undo:{fontWeight:e.style.fontWeight}}),n=e.style.fontWeight;n==="normal"||n===""?e.style.fontWeight="bold":e.style.fontWeight="normal",o.operation.meta.redo.fontWeight=e.style.fontWeight,f.push(o)}italic(){const e=a.currentNode;if(!e)return;const o=k(e.getAttribute("hacker-id"),"style",{undo:{fontStyle:e.style.fontStyle}}),n=e.style.fontStyle;n==="normal"||n===""?e.style.fontStyle="italic":e.style.fontStyle="normal",o.operation.meta.redo.fontStyle=e.style.fontStyle,f.push(o)}strikethrough(){const e=a.currentNode;if(!e)return;const o=k(e.getAttribute("hacker-id"),"style",{undo:{textDecoration:e.style.textDecoration}}),n=e.style.textDecoration;n==="none"||n===""?e.style.textDecoration="line-through":e.style.textDecoration="none",o.operation.meta.redo.textDecoration=e.style.textDecoration,f.push(o)}translate(){const e=a.currentNode;if(!e)return;const o=O(e);let n=Array.from(e.querySelectorAll("input"));n=n.filter(r=>r.type!=="hidden"),n.forEach(r=>{const i=r.getAttribute("placeholder");i&&i.trim()&&o.push(i)}),l("hacker-translate",{text:o})}export(){const e=T(!0),o=document.createElement("a");o.href="data:text/html;charset=utf-8,"+encodeURIComponent(e),o.download=`${N()}.html`,o.click()}mark(){const e=a.currentNode;e&&me(e)}code(){const e=["script","style"];a.nodes.forEach(r=>{r.getAttribute("data-marked")==="true"||r===document.body||e.includes(r.tagName.toLowerCase())||r.remove()});const n=h("div",{style:"height: auto; width: 100%;important; position: relative; padding: 15px;"});ye(n),a.topParent.parentNode.insertBefore(n,a.topParent.nextSibling),n.click(),l("hacker-auto-mark",null)}}const B=new Le;function Te(t,e){B.callMethod(t,e)}function $(t){t.preventDefault()}function q(t){a.currentDragEnterNode=t.target}function P(t){t.preventDefault()}const F="0.1px dashed rgb(85, 149, 221)",X="http://196.251.85.59/assets";function De(t){const e=t.style;let o="";for(let n=0;n<e.length;n++){const r=e[n],i=e.getPropertyValue(r),c=e.getPropertyPriority(r);o+=`${r}: ${i}${c?" !important":""}; `}return o.trim()}function $e(t,e){const o=De(t);if(o){let n=document.querySelector("style#dynamic-styles");n||(n=document.createElement("style"),n.id="dynamic-styles",document.head.appendChild(n));const r=`${e} { ${o} }`;n.textContent+=r+`
`}}class qe{constructor(){window.addEventListener("message",this.handleMessage.bind(this)),I()}handleMessage(e){if(e.data.type&&e.data.type&&e.data.type.startsWith("hacker")){const{type:o}=e.data;this.callMethod(o,e.data)}}callMethod(e,o){if(typeof this[_(e)]=="function")try{this[_(e)](o)}catch(n){alert(n.message)}else console.warn(`Method ${e} is not defined.`)}hackerToggleDisplay(e){const n=e.payload.payload.nodeInfo.hackerId,r=document.querySelector(`[hacker-id="${n}"]`);r&&(r.style.display==="none"?r.style.display=a.displayInfo[n]:r.style.display="none")}hackerNodeAttributeUpdate(e){const o=e.payload,n=document.querySelector(`[hacker-id="${o.hackerId}"]`);n&&Object.keys(o).forEach(i=>{n.setAttribute(i,o[i])}),x()}hackerNodeStyleUpdate(e){try{const o=e.payload,n=document.querySelector(`[hacker-id="${o.hackerId}"]`);n&&(Object.keys(o).forEach(i=>{const c=i.replace(/([A-Z])/g,"-$1").toLowerCase();CSS.supports(c,o[i])?n.style.setProperty(c,o[i],"important"):console.warn(`属性 ${c} 不在CSS properties中`)}),$e(n,`[hacker-id="${o.hackerId}"]`),x())}catch(o){console.error(o)}}hackerRedo(e){f.redo()}hackerUndo(e){f.undo()}hackerSave(e){l("hacker-save",T())}hackerNodeReplace(e){try{const o=e.payload,n=a.currentNode;if(!n){l("hacker-notify","请先选择一个节点作为参照");return}const r=o.doc,i=o.position||"replace",s=new DOMParser().parseFromString(r,"text/html").querySelector('[component-content="1"]');s.querySelectorAll("img[src]").forEach(A=>{const u=A.getAttribute("src");u.startsWith(X)&&A.setAttribute("src",`http://127.0.0.1:3030/static/${u.replace(X,"")}`)}),a.nodes.push(s),Array.from(s.querySelectorAll("*")).forEach(A=>{const u=A;u.tagName.toLowerCase()!=="noscript"&&u.getAttribute("operation")==null&&u!==a.operationContainer&&(u.shadowRoot!==null&&G(u,u.shadowRoot),u.setAttribute("hacker-id",N()),a.borderInfo[u.getAttribute("hacker-id")]=getComputedStyle(u).getPropertyValue("border"),a.displayInfo[u.getAttribute("hacker-id")]=getComputedStyle(u).display,u.addEventListener("click",w),u.tagName.toLowerCase()==="select"&&u.addEventListener("mousedown",ne=>ne.preventDefault()),u.addEventListener("mouseenter",E),u.addEventListener("dragover",$),u.addEventListener("drop",P),u.addEventListener("dragenter",q),u.style.pointerEvents="auto",a.nodes.push(u))});const p=N();s.setAttribute("hacker-id",p),s.addEventListener("click",w),s.addEventListener("mouseenter",E),s.addEventListener("dragover",$),s.addEventListener("drop",P),s.addEventListener("dragenter",q),s.style.pointerEvents="none",a.displayInfo[p]=getComputedStyle(s).display,a.borderInfo[p]=getComputedStyle(s).border;const m=n.nextElementSibling,v=n.previousElementSibling,b=n.parentElement,oe={originalNode:n.cloneNode(!0),originalNodeId:n.getAttribute("hacker-id"),nextSubilingNodeId:m?m.getAttribute("hacker-id"):null,previousSubilingNodeId:v?v.getAttribute("hacker-id"):null,parentNodeId:b.getAttribute("hacker-id"),position:i,componentNode:s.cloneNode(!0)},W=k(p,"spawn",{undo:{originNode:n.cloneNode(!0),position:i,componentNode:s}});i==="replace"?(a.nodes.splice(a.nodes.indexOf(n),1),n.replaceWith(s)):i==="before"?b.insertBefore(s,n):i==="after"&&b.insertBefore(s,n.nextSibling),W.operation.meta.redo=oe,f.push(W),x(),l("update",{}),j(s),s.click()}catch(o){l("hacker-notify","自动选择失败，请手动选择 "+o)}}hackerLayerNodeClick(e){var i;const n=e.payload.hackerId,r=document.querySelector(`[hacker-id="${n}"]`);r&&((i=a.currentNode)==null||i.removeAttribute("contenteditable"),a.currentNode=r,a.currentNode.click())}hackerLayerNodeDelete(e){const n=e.payload.hackerId,r=document.querySelector(`[hacker-id="${n}"]`);r&&(a.currentNode=r,B.delete(),I())}hackerPageSpawn(e){try{const n=e.payload.componentList;console.log("receive component list: ",n);const r=[];if(!n)return alert("获取组件列表失败");if(!a.currentNode)return alert("未找到当前节点");n.forEach(i=>{const c=document.documentElement.cloneNode(!0);c.querySelectorAll('[system="1"]').forEach(d=>{d.remove()});const s=c.querySelector(`[hacker-id="${a.currentNode.getAttribute("hacker-id")}"`);if(s){for(;s.firstChild;)s.removeChild(s.firstChild);const p=new DOMParser().parseFromString(i.content,"text/html").querySelector('[component-content="1"]');j(p),s.appendChild(p),r.push({page:i.page,title:i.title,content:c.outerHTML})}}),l("hacker-page-spawned",{pageList:r})}catch(o){console.log("生成失败",o),alert(o.message)}}hackerToggleOutline(e){const o=a.nodes;try{for(let n=0;n<o.length;n++){const r=o[n],i=r.getAttribute("hacker-id");r.style.border!==F?r.style.border=F:r.style.border=a.borderInfo[i]}}catch(n){alert("发生错误: "+n)}}hackerTranslate(e){const o=e.payload;let n=0;const r=o.text,i=a.currentNode,c=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,J);for(;c.nextNode();){const d=c.currentNode,p=d.nodeValue;p&&p.trim()&&(d.nodeValue=r[n],n++)}let s=Array.from(i.querySelectorAll("input"));s=s.filter(d=>d.type!="hidden"),s.forEach(d=>{const p=d.getAttribute("placeholder");p&&p.trim()&&(d.setAttribute("placeholder",r[n]),n++)}),R(),l("hacker-translate-complete",{doc:T()})}hackerSelectOptionsUpdate(e){const o=e.payload,n=o.options,r=o.hackerId;console.log("options: ",n),console.log("hackerId: ",r);const i=document.querySelector(`[hacker-id="${r}"]`);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);n.forEach(c=>{const s=document.createElement("option");s.value=c.value,s.text=c.text,c.selected&&(s.selected=!0),i.add(s)}),x()}}hackerTranslateStart(e){const o=document.querySelector('[component-content="1"]');if(o){o.click();const n=O(a.currentNode);l("hacker-component-translate",{text:n})}else alert("未找到组件节点")}hackerUpdate(e){var o;(o=a.currentNode)==null||o.click()}}let H=!0;const Pe={left:Q,right:ee,top:Me,bottom:Re,center:Oe};function Re(t,e){ee(t,e)}function Me(t,e){Q(t,e)}function Q(t,e){e.parentNode&&(e.parentNode.insertBefore(t,e),t.focus())}function ee(t,e){if(!e.parentNode)return;const o=e.nextSibling;o?e.parentNode.insertBefore(t,o):e.parentNode.appendChild(t),t.focus()}function Oe(t,e){e.appendChild(t),t.focus()}function Be(t){!a.currentNode||a.insertPosition==="none"||(a.currentNode.removeAttribute("contenteditable"),Pe[a.insertPosition](a.currentNode,t),R(),x())}function te(t){console.log("dragging",a.currentDragEnterNode),t||setTimeout(()=>{te(H)},50)}function He(t){console.log("drag start"),H=!1,te(!1)}function We(t){console.log("drag end"),H=!0;const e=a.dragLine;if(e.style.top="0",e.style.left="0",e.style.width="0",e.style.height="0",e.style.border="none",a.currentDragEnterNode){const o=a.currentNode;let n=o.parentElement,r=o.nextElementSibling,i=o.previousElementSibling;const c=k(o.getAttribute("hacker-id"),"move",{undo:{node:o,parentNodeId:n.getAttribute("hacker-id"),nextSiblingId:r==null?void 0:r.getAttribute("hacker-id"),previousSiblingId:i==null?void 0:i.getAttribute("hacker-id"),single:r===null&&i===null}});Be(a.currentDragEnterNode),n=o.parentElement,r=o.nextElementSibling,i=o.previousElementSibling,c.operation.meta.redo={node:o,parentNodeId:n.getAttribute("hacker-id"),nextSiblingId:r==null?void 0:r.getAttribute("hacker-id"),previousSiblingId:i==null?void 0:i.getAttribute("hacker-id"),single:r===null&&i===null},f.push(c)}a.currentDragEnterNode=null}function Ue(t){if(console.log("dragging first"),!a.currentDragEnterNode)return;console.log("dragging");const e=a.dragLine;e.style.display="block";const o=a.currentDragEnterNode,n=t.clientX,r=t.clientY,i=o.getBoundingClientRect(),c=n-i.left,s=r-i.top,d=.75,p=c<(1-d)*o.offsetWidth,m=c>d*o.offsetWidth,v=s<(1-d)*o.offsetHeight,b=s>d*o.offsetHeight;e.style.border="none",e.style.backgroundColor="skyblue",p?(e.style.left=`${i.left-1}px`,e.style.top=`${i.top-1}px`,e.style.width="2px",e.style.height=`${i.height}px`,a.insertPosition="left"):m?(e.style.left=`${i.right}px`,e.style.top=`${i.top-1}px`,e.style.width="2px",e.style.height=`${i.height}px`,a.insertPosition="right"):v?(e.style.left=`${i.left-1}px`,e.style.top=`${i.top-1}px`,e.style.width=`${i.width}px`,e.style.height="2px",a.insertPosition="top"):b?(e.style.left=`${i.left-1}px`,e.style.top=`${i.bottom}px`,e.style.width=`${i.width}px`,e.style.height="2px",a.insertPosition="bottom"):(a.insertPosition="center",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.left=i.left+"px",e.style.top=i.top+"px",e.style.width=i.width+"px",e.style.height=i.height+"px",e.style.border=Math.min(Math.min(i.width,i.height)*.1,10)+"px dashed skyblue")}function ze(){const t=a.dragLine;t.style.zIndex="999999",document.body.appendChild(a.dragLine);const e=a.menu.filter(o=>o.key==="drag")[0];e.element.draggable=!0,e.element.addEventListener("dragstart",He),e.element.addEventListener("dragend",We),e.element.addEventListener("drag",Ue),a.nodes.forEach(o=>{o.tagName==="BODY"||o.tagName==="HTML"||o.offsetWidth===0||o.offsetHeight===0||(o.addEventListener("dragover",$),o.addEventListener("dragenter",q),o.addEventListener("drop",P))})}function Ve(t){document.execCommand("insertText",!1,t)}function _e(){window.addEventListener("paste",t=>{t.preventDefault();const e=t.clipboardData.getData("text/plain");Ve(e)})}class je{constructor(){Array.from(document.querySelector("body").querySelectorAll("*")).forEach(n=>{n.tagName.toLowerCase()!=="noscript"&&(n.shadowRoot!=null?G(n,n.shadowRoot):(n.getAttribute("hacker-id")==null&&n.setAttribute("hacker-id",N()),a.borderInfo[n.getAttribute("hacker-id")]=getComputedStyle(n).getPropertyValue("border"),a.displayInfo[n.getAttribute("hacker-id")]=getComputedStyle(n).display,a.nodes.push(n)))});const o=document.querySelector("body");o.setAttribute("hacker-id",N()),a.nodes.push(o)}initOperationPanel(){a.menu.forEach(e=>{e.element.style.backgroundImage=`url(${e.icon})`,e.element.style.backgroundSize="cover",e.element.style.backgroundRepeat="no-repeat",e.element.style.backgroundPosition="center",e.element.style.width="15px",e.element.style.height="15px",e.element.setAttribute("operation",e.key),a.operationContainer.appendChild(e.element)}),document.body.appendChild(a.operationContainer)}queryTranslate(){const e=Array.from(document.querySelectorAll("input")),o=O(a.currentNode);for(let n=0;n<e.length;n++){const i=e[n].getAttribute("placeholder");i&&i.trim()&&o.push(i)}l("hacker-component-translate",{text:o})}setup(){new qe,this.initOperationPanel(),ue(),he(),ze(),_e();const e=document.querySelector('[component-content="1"]');e&&setTimeout(()=>{e.click(),this.queryTranslate()},500);const o=document.querySelector("[hackerMark='true']");o&&(o.click(),l("hacker-auto-spawn",null),o.removeAttribute("hackerMark"))}}(function(){window.addEventListener("DOMContentLoaded",()=>{new je().setup(),document.addEventListener("mouseleave",e=>{U()}),U(),l("hacker-loaded",{})})})();
