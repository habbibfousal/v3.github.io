var ne=Object.defineProperty;var oe=(t,e,n)=>e in t?ne(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var v=(t,e,n)=>oe(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();const p=(t,e)=>{const n=document.createElement(t);return Object.keys(e).forEach(o=>{n.setAttribute(o,e[o])}),n},f="http://127.0.0.1:3030/assets/",a={currentNode:null,nodes:[],observer:{currentNode:null,currentHoverNode:null},currentHoverNode:null,borderInfo:{},currentDragEnterNode:null,displayInfo:{},insertPosition:"none",excludeTags:["script","style","meta","link"],hoverTipContainer:p("div",{system:"1",style:"pointer-events: none; position: absolute;"}),selectedTipContainer:p("div",{system:"1",style:"pointer-events: none; position: absolute;"}),operationContainer:p("div",{system:"1",class:"flex",style:"position: absolute; gap: 5px; padding: 5px; background-color: #38bdf8; cursor: pointer; "}),hoverNodeNameTipContainer:p("div",{system:"1",style:"padding-left: 10px; padding-right: 10px; background-color: #38bdf8; color: white; pointer-events: none; position: absolute;"}),selectedNodeNameTipContainer:p("div",{system:"1",style:"padding-left: 10px; padding-right: 10px; background-color: #f87171; color: white; pointer-events: none; position: absolute; z-index: 1000;"}),dragLine:p("div",{system:"1",style:"position: fixed; left: 0; top: 0; pointer-events: none; background-color: #f87171;"}),menu:[{icon:f+"icons/up.png",key:"up",element:p("div",{system:"1"})},{icon:f+"icons/down.png",key:"down",element:p("div",{system:"1"})},{icon:f+"icons/underline.png",key:"underline",element:p("div",{system:"1"})},{icon:f+"icons/italic.png",key:"italic",element:p("div",{system:"1"})},{icon:f+"icons/bold.png",key:"bold",element:p("div",{system:"1"})},{icon:f+"icons/strikethrough.png",key:"strikethrough",element:p("div",{system:"1"})},{icon:f+"icons/drag.png",key:"drag",element:p("div",{system:"1"})},{icon:f+"icons/copy.png",key:"copy",element:p("div",{system:"1"})},{icon:f+"icons/translate.png",key:"translate",element:p("div",{system:"1"})},{icon:f+"icons/export.png",key:"export",element:p("div",{system:"1"})},{icon:f+"icons/delete.png",key:"delete",element:p("div",{system:"1"})}],markedNodes:new Map,markedList:[],topParent:null};function l(t,e){window.parent.postMessage({type:t,data:e},"*")}function E(){l("hacker-un-save",{})}function R(){a.hoverTipContainer.style.display="none",a.selectedTipContainer.style.display="none",a.hoverNodeNameTipContainer.style.display="none",a.selectedNodeNameTipContainer.style.display="none",a.dragLine.style.display="none",a.operationContainer.style.opacity="0"}function U(){a.hoverTipContainer.style.display="none",a.hoverNodeNameTipContainer.style.display="none",a.operationContainer.style.display="none"}function re(t){const e=getComputedStyle(t),n=i=>i.replace(/-([a-z])/g,(s,c)=>c.toUpperCase()),o={};for(let i of e){const s=n(i);o[s]=e.getPropertyValue(i)}const r={...o,hackerId:t.getAttribute("hacker-id"),hackerMark:t.getAttribute("data-hacker-mark")||!1,id:t.getAttribute("id"),src:t.getAttribute("src"),href:t.getAttribute("href"),target:t.getAttribute("data-target")||"none",placeholder:t.getAttribute("placeholder"),name:t.getAttribute("name"),type:t.getAttribute("type"),classList:t.className,hoverClass:t.getAttribute("data-hover-class")||"",disabledClass:t.getAttribute("data-disabled-class")||"",classType:typeof t.className,tagName:t.tagName.toLowerCase(),height:t.style.height||t.offsetHeight,width:t.style.width||t.offsetWidth,text:t.innerText,srcset:t.getAttribute("srcset"),borderRadius:e.borderRadius,borderStyle:e.borderStyle,borderWidth:e.borderWidth,borderColor:e.borderColor,backgroundColor:e.backgroundColor,triggerTiming:t.getAttribute("data-trigger-timing")||"none",triggerType:t.getAttribute("data-trigger-type")||"system",triggerCode:t.getAttribute("data-trigger-code")||"",triggerEvent:t.getAttribute("data-trigger-event")||"none",targetState:t.getAttribute("data-target-state")||"default",targetId:t.getAttribute("data-target-id")||"",targetLink:t.getAttribute("data-target-link")||"",macroId:t.getAttribute("data-macro-id")||"",macroValue:t.getAttribute("data-macro-value")||"",disabled:t.getAttribute("data-disabled")||"false"};(t.tagName.toLowerCase()==="input"||t.tagName.toLowerCase()==="textarea")&&Object.assign(r,{sensitive:t.getAttribute("data-sensitive")||"",alias:t.getAttribute("data-alias")||t.getAttribute("name"),mode:t.getAttribute("data-mode")||"system",rule:t.getAttribute("data-rule")||"none",msg:t.getAttribute("data-msg")||"",required:t.getAttribute("required")||"false",user:t.getAttribute("data-user")||"",minLength:t.getAttribute("minlength")||"",maxLength:t.getAttribute("maxlength")||""}),l("hacker-node-info",r)}const g=[];for(let t=0;t<256;++t)g.push((t+256).toString(16).slice(1));function ie(t,e=0){return(g[t[e+0]]+g[t[e+1]]+g[t[e+2]]+g[t[e+3]]+"-"+g[t[e+4]]+g[t[e+5]]+"-"+g[t[e+6]]+g[t[e+7]]+"-"+g[t[e+8]]+g[t[e+9]]+"-"+g[t[e+10]]+g[t[e+11]]+g[t[e+12]]+g[t[e+13]]+g[t[e+14]]+g[t[e+15]]).toLowerCase()}let T;const ae=new Uint8Array(16);function se(){if(!T){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");T=crypto.getRandomValues.bind(crypto)}return T(ae)}const ce=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),z={randomUUID:ce};function N(t,e,n){var r;if(z.randomUUID&&!t)return z.randomUUID();t=t||{};const o=t.random??((r=t.rng)==null?void 0:r.call(t))??se();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=o[6]&15|64,o[8]=o[8]&63|128,ie(o)}function X(t,e,n=4,o=4){const{top:r,left:i,width:s,height:c}=t;e.style.top=`${r-n+window.scrollY}px`,e.style.left=`${i-o+window.scrollX}px`,e.style.width=`${s+o*2}px`,e.style.height=`${c+n*2}px`}function Y(t,e,n,o=2,r=2){t.innerText=e,t.style.display="block",t.style.left=`${n.left+o+window.scrollX}px`,t.style.top=`${n.top-t.offsetHeight+r+window.scrollY}px`}function C(t){const e=t.target;a.currentHoverNode=e,a.observer.currentHoverNode=e;const n=e.getBoundingClientRect(),o=a.hoverTipContainer;o.style.display="block",X(n,o,2,2),o.style.border="1px dashed #38bdf8";const r=e.tagName.toLowerCase();Y(a.hoverNodeNameTipContainer,r,n,-2,-2)}function M(t){t.stopPropagation()}function le(){a.hoverTipContainer.style.zIndex="99999",a.hoverNodeNameTipContainer.style.zIndex="99999",document.body.appendChild(a.hoverTipContainer),document.body.appendChild(a.hoverNodeNameTipContainer),a.nodes.forEach(t=>{t.addEventListener("mouseenter",C),t.addEventListener("mouseleave",M),t.style.userSelect="none"})}function w(t){const e=t.target;if(e.getAttribute("system")=="1"||a.excludeTags.includes(e.tagName.toLowerCase()))return;a.currentNode!==null&&a.currentNode!==e&&a.currentNode.setAttribute("contenteditable","false"),a.currentNode=e,a.currentNode.tagName.toLowerCase()!="img"&&a.currentNode.setAttribute("contenteditable","true"),e.focus();const n=e.getBoundingClientRect();a.currentHoverNode===e&&C(t),de(n),a.selectedTipContainer.style.border="2px dashed #f87171",a.selectedTipContainer.style.display="block",X(n,a.selectedTipContainer,2,2),Y(a.selectedNodeNameTipContainer,e.tagName.toLowerCase(),n,-2,-2),E(),re(e),e.closest("a")&&t.preventDefault()}function de(t){const e=a.operationContainer;e.style.display="flex",e.style.opacity="1",e.style.zIndex="999999999",e.style.left=`${t.left+window.scrollX}px`,e.style.top=`${t.bottom+window.scrollY}px`;const n=e.offsetWidth,o=e.offsetHeight,r=window.innerWidth,i=window.innerHeight;e.offsetLeft+n>r&&(e.style.left=`${r-n}px`),Math.ceil(t.top+t.height)>=i&&(e.style.top=`${i-o+window.scrollY}px`)}function ue(){a.selectedTipContainer.style.zIndex="99999",document.body.appendChild(a.selectedTipContainer),document.body.appendChild(a.selectedNodeNameTipContainer),a.nodes.forEach(t=>{t.addEventListener("click",w),t.style.userSelect="none"}),a.menu.forEach(t=>{t.key!=="drag"&&(t.element.onclick=e=>Ie(t.key,null))})}function V(t){t.setAttribute("hacker-id",N()),a.nodes.push(t),t.onmouseleave=M,t.onclick=w,t.onmouseenter=C,l("update",{})}function pe(){}const he=["script","style","noscript","meta","link","head"];function _(t){return t.split("-").map((e,n)=>n===0?e:e.charAt(0).toUpperCase()+e.slice(1)).join("")}function K(t,e){const n=r=>{r.shadowRoot&&o(r,r.shadowRoot),r.setAttribute("shadow","1"),r.onclick=i=>{i.preventDefault(),a.currentNode=r},r.setAttribute("hacker-id",N()),a.nodes.push(r),a.borderInfo[r.getAttribute("hacker-id")]=getComputedStyle(r).border;for(let i=0;i<r.children.length;i++)n(r.children[i])},o=(r,i)=>{for(let s=0;s<i.children.length;s++){const c=i.children[s];n(c)}r.addEventListener("scroll",pe)};o(t,e)}function O(t){const e=[],n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,G);for(;n.nextNode();){const r=n.currentNode.nodeValue;r&&r.trim()&&e.push(r)}return e}const G={acceptNode(t){var e;return(e=t.parentElement)!=null&&e.tagName.match(/^(SCRIPT|STYLE|CODE)$/i)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}};function L(t=!1){const e=document.documentElement.cloneNode(!0);return e.querySelectorAll('[system="1"]').forEach(n=>{n.remove()}),t&&e.querySelectorAll('[kernel="inject"]').forEach(n=>{n.remove()}),e.outerHTML}const ge=t=>{t.addEventListener("click",w),t.addEventListener("mouseenter",C),t.addEventListener("mouseleave",M),t.setAttribute("hacker-id",N()),a.nodes.push(t)},J=t=>{const e=[];return Array.from(t.children).forEach(o=>{o instanceof HTMLElement&&(e.push(o),e.push(...J(o)))}),e},I=t=>{const e=document.body;if(!e)return console.error("未找到指定的容器元素"),null;function n(r,i=0,s="0"){if(!r||r.nodeType===Node.COMMENT_NODE||r.nodeType===Node.TEXT_NODE||r.tagName.toLowerCase()==="noscript"||r.attributes===void 0||r.getAttribute("operation")!==null||r.getAttribute("tools")!==null||he.includes(r.tagName.toLowerCase()))return null;const c={title:r.tagName?r.tagName.toLowerCase():null,attributes:{},children:[],key:s,content:null,hackerId:r.getAttribute("hacker-id")||null};if(r.nodeType===Node.ELEMENT_NODE){for(const h of r.attributes);r.shadowRoot&&Array.from(r.shadowRoot.children).forEach((m,x)=>{const b=n(m,i+1,`${s}-shadow-${x}`);b&&c.children.push(b)})}let d=0;for(const h of r.childNodes){const m=n(h,i+1,`${s}-${d}`);m&&(c.children.push(m),d++)}return r.textContent&&r.textContent.trim()&&c.children.length,c}const o=n(e);l("hacker-layer",o)};function ye(t){const e=fe(t),n=new Set(e);if(a.markedNodes.has(t)){const i=a.markedNodes.get(t);i&&(i.remove(),a.markedNodes.delete(t)),n.forEach(s=>{s.removeAttribute("data-marked"),a.markedNodes.delete(s)});return}const o=p("div",{style:"position: absolute; z-index: 9999; pointer-events: none; border: 2px dashed green; border-radius: 5px;"}),r=t.getBoundingClientRect();o.style.top=`${r.top+window.scrollY}px`,o.style.left=`${r.left+window.scrollX}px`,o.style.width=`${r.width}px`,o.style.height=`${r.height}px`,a.markedNodes.set(t,o),document.body.appendChild(o),n.forEach(i=>{i.setAttribute("data-marked","true")})}function fe(t,e=!1){if(!(t instanceof HTMLElement))throw new Error("输入参数必须是 HTMLElement 类型");const n=new Set([t]);let o=t.parentElement,r=t;for(;o&&(e?o!==document.documentElement:o!==document.body);)n.add(o),r=o,o=o.parentElement;const i=s=>{Array.from(s.children).forEach(d=>{d instanceof HTMLElement&&(n.add(d),i(d))})};if(i(r),a.topParent===null)a.topParent=r;else{const s=a.topParent.getBoundingClientRect();r.getBoundingClientRect().top<s.top&&(a.topParent=r)}return n}function me(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`);e&&(a.nodes=a.nodes.filter(n=>n!==e),e.remove())}function be(t){const e=t.operation.meta.redo,n=e.node,o=document.querySelector(`[hacker-id="${e.parentNodeId}"]`),r=document.querySelector(`[hacker-id="${e.nextSiblingId}"]`);r?o.insertBefore(n,r):o.appendChild(n),y.push(t)}function ke(t){const e=t.operation.meta.undo,n=e.single,o=document.querySelector(`[hacker-id="${e.parentNodeId}"]`);if(n)o.appendChild(e.node);else{const r=e.nextSiblingId,i=e.previousSiblingId,s=document.querySelector(`[hacker-id="${r}"]`),c=document.querySelector(`[hacker-id="${i}"]`);s?o.insertBefore(e.node,s):c&&c.nextElementSibling?o.insertBefore(e.node,c.nextElementSibling):o.appendChild(e.node)}}function Ne(t){const n=t.operation.meta.redo.nodeId,o=document.querySelector(`[hacker-id="${n}"]`);o&&(o.click(),B.delete())}function Se(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),n=t.operation.meta.undo,o=document.querySelector(`[hacker-id="${n.parentNodeId}"]`);if(n.single)o.appendChild(e);else{const r=n.nextSiblingId,i=n.previousSiblingId,s=document.querySelector(`[hacker-id="${r}"]`),c=document.querySelector(`[hacker-id="${i}"]`);s?o.insertBefore(e,s):c&&c.nextElementSibling?o.insertBefore(e,c.nextElementSibling):o.appendChild(e)}}function xe(t){const e=t.operation.meta.redo,n=document.querySelector(`[hacker-id="${e.parentNodeId}"]`),o=document.querySelector(`[hacker-id="${t.hackerId}"]`);if(e.single)n.appendChild(o);else{const r=e.nextSiblingId,i=e.previousSiblingId,s=document.querySelector(`[hacker-id="${r}"]`),c=document.querySelector(`[hacker-id="${i}"]`);s?n.insertBefore(o,s):c&&c.nextElementSibling?n.insertBefore(o,c.nextElementSibling):n.appendChild(o)}y.push(t)}function ve(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),n=t.operation.meta.undo;e?n.position==="replace"?e.replaceWith(n.originNode):n.componentNode.remove():l("hacker-notify","节点丢失，本次操作失败")}function Ee(t){const e=t.operation.meta.redo,n=document.querySelector(`[hacker-id="${e.parentNodeId}"]`);if(n){const o=e.componentNode,r=e.position,i=document.querySelector(`[hacker-id="${e.originalNodeId}"]`);if(e.originalNode=i.cloneNode(!0),e.componentNode=o.cloneNode(!0),r==="replace")i.replaceWith(o);else if(r==="before")n.insertBefore(o,i);else if(r==="after")n.insertBefore(o,i.nextSibling);else{l("hacker-notify","未定义的操作");return}t.operation.meta.redo={...e},t.operation.meta.undo.componentNode=o,y.push(t)}else l("hacker-notify","父节点丢失，本次操作失败")}function Ce(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),n=t.operation.meta.undo;Object.keys(n).forEach(o=>{e.style[o]=n[o]})}function we(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),n=t.operation.meta.redo;Object.keys(n).forEach(o=>{e.style[o]=n[o]})}const S=class S{constructor(){v(this,"undoStack",[]);v(this,"redoStack",[]);v(this,"maxStackSize",100)}static get Instance(){return S.instance||(S.instance=new S),S.instance}push(e){this.undoStack.length>=this.maxStackSize&&this.undoStack.shift(),this.undoStack.push(e)}pop(e){const n=e==="undo"?this.undoStack:this.redoStack;if(n.length>0){const o=n.pop();return e==="undo"&&this.redoStack.push(o),o}return null}redo(){const e=this.pop("redo");if(e){switch(e.operation.type){case"style":we(e);break;case"delete":Ne(e);break;case"move":xe(e);break;case"copy":be(e);break;case"spawn":Ee(e);break;default:l("hacker-notify","editor.redo.not-supported");break}I()}else l("hacker-notify","editor.redo.none")}undo(){const e=this.pop("undo");if(e){switch(e.operation.type){case"style":Ce(e);break;case"delete":ke(e);break;case"move":Se(e);break;case"copy":me(e);break;case"spawn":ve(e);break;default:l("hacker-notify","editor.undo.not-supported");break}I()}else l("hacker-notify","editor.undo.none")}};v(S,"instance");let D=S;const y=D.Instance;function k(t,e,n){return{hackerId:t,operation:{type:e,meta:{undo:{},redo:{},...n}}}}class Ae{constructor(){v(this,"metaOrCtrlIsPressed",!1);window.addEventListener("keyup",e=>{(e.key==="Meta"||e.key==="Control")&&(this.metaOrCtrlIsPressed=!1)}),window.addEventListener("keydown",e=>{switch((e.key==="Meta"||e.key==="Control")&&(this.metaOrCtrlIsPressed=!0),e.key){case"ArrowUp":this.up();break;case"ArrowDown":this.down();break;case"Delete":this.delete();break;case"Backspace":{this.metaOrCtrlIsPressed&&this.delete();break}case"z":this.metaOrCtrlIsPressed&&y.undo();break}})}callMethod(e,n){typeof this[e]=="function"?this[e](n):console.warn(`Method ${e} is not defined.`)}copy(){const e=a.currentNode;e.removeAttribute("contenteditable");const n=e.cloneNode(!0);n.setAttribute("contenteditable","false");const o=e.parentElement;if(o){let r=e.nextElementSibling;r?o.insertBefore(n,e.nextSibling):o.appendChild(n),a.currentNode=n,V(n);const i=k(n.getAttribute("hacker-id"),"copy",{undo:{}});n.click(),r=n.nextElementSibling,l("update",{}),J(n).forEach(s=>{V(s)}),i.operation.meta.redo={node:n.cloneNode(!0),parentNodeId:o.getAttribute("hacker-id"),nextSiblingId:r?r.getAttribute("hacker-id"):null},y.push(i)}else l("hacker-notify","无法复制节点，因为当前节点没有父节点")}delete(){const e=a.currentNode;if(e.tagName.toLowerCase()==="body"||e===document.body||e.tagName.toLowerCase()==="html"){l("hacker-notify","无法删除根节点");return}const n=e.parentElement,o=e.nextElementSibling,r=e.previousElementSibling,i=k(e.getAttribute("hacker-id"),"delete",{undo:{node:e.cloneNode(!0),parentNodeId:n.getAttribute("hacker-id"),nextSiblingId:o?o.getAttribute("hacker-id"):null,previousSiblingId:r?r.getAttribute("hacker-id"):null,single:o===null&&r===null}});a.nodes=a.nodes.filter(s=>s!==e),e.remove(),a.currentNode=null,l("update",{}),l("clearNodeInfo",{}),E(),R(),i.operation.meta.redo={nodeId:i.hackerId},console.log("delete state: ",i),y.push(i)}up(){const n=a.currentNode.parentNode;n&&n.click()}down(){const e=a.currentNode;if(!e)return;const n=Array.from(e.children);n.length>0&&(a.currentNode=n[0],a.currentNode.click())}underline(){const e=a.currentNode;if(!e)return;const n=e.style.textDecoration,o=k(e.getAttribute("hacker-id"),"style",{undo:{textDecoration:n}});n==="none"||n===""?e.style.textDecoration="underline":e.style.textDecoration="none",o.operation.meta.redo.textDecoration=e.style.textDecoration,y.push(o)}bold(){const e=a.currentNode;if(!e)return;const n=k(e.getAttribute("hacker-id"),"style",{undo:{fontWeight:e.style.fontWeight}}),o=e.style.fontWeight;o==="normal"||o===""?e.style.fontWeight="bold":e.style.fontWeight="normal",n.operation.meta.redo.fontWeight=e.style.fontWeight,y.push(n)}italic(){const e=a.currentNode;if(!e)return;const n=k(e.getAttribute("hacker-id"),"style",{undo:{fontStyle:e.style.fontStyle}}),o=e.style.fontStyle;o==="normal"||o===""?e.style.fontStyle="italic":e.style.fontStyle="normal",n.operation.meta.redo.fontStyle=e.style.fontStyle,y.push(n)}strikethrough(){const e=a.currentNode;if(!e)return;const n=k(e.getAttribute("hacker-id"),"style",{undo:{textDecoration:e.style.textDecoration}}),o=e.style.textDecoration;o==="none"||o===""?e.style.textDecoration="line-through":e.style.textDecoration="none",n.operation.meta.redo.textDecoration=e.style.textDecoration,y.push(n)}translate(){const e=a.currentNode;if(!e)return;const n=O(e);let o=Array.from(e.querySelectorAll("input"));o=o.filter(r=>r.type!=="hidden"),o.forEach(r=>{const i=r.getAttribute("placeholder");i&&i.trim()&&n.push(i)}),l("hacker-translate",{text:n})}export(){const e=L(!0),n=document.createElement("a");n.href="data:text/html;charset=utf-8,"+encodeURIComponent(e),n.download=`${N()}.html`,n.click()}mark(){const e=a.currentNode;e&&ye(e)}code(){const e=["script","style"];a.nodes.forEach(r=>{r.getAttribute("data-marked")==="true"||r===document.body||e.includes(r.tagName.toLowerCase())||r.remove()});const o=p("div",{style:"height: auto; width: 100%;important; position: relative; padding: 15px;"});ge(o),a.topParent.parentNode.insertBefore(o,a.topParent.nextSibling),o.click(),l("hacker-auto-mark",null)}}const B=new Ae;function Ie(t,e){B.callMethod(t,e)}function $(t){t.preventDefault()}function P(t){a.currentDragEnterNode=t.target}function q(t){t.preventDefault()}const j="0.1px dashed rgb(85, 149, 221)",F="http://196.251.85.59/assets";function Te(t){const e=t.style;let n="";for(let o=0;o<e.length;o++){const r=e[o],i=e.getPropertyValue(r),s=e.getPropertyPriority(r);n+=`${r}: ${i}${s?" !important":""}; `}return n.trim()}function Le(t,e){const n=Te(t);if(n){let o=document.querySelector("style#dynamic-styles");o||(o=document.createElement("style"),o.id="dynamic-styles",document.head.appendChild(o));const r=`${e} { ${n} }`;o.textContent+=r+`
`}}class De{constructor(){window.addEventListener("message",this.handleMessage.bind(this)),I()}handleMessage(e){if(e.data.type&&e.data.type&&e.data.type.startsWith("hacker")){const{type:n}=e.data;this.callMethod(n,e.data)}}callMethod(e,n){if(typeof this[_(e)]=="function")try{this[_(e)](n)}catch(o){alert(o.message)}else console.warn(`Method ${e} is not defined.`)}hackerToggleDisplay(e){const o=e.payload.payload.nodeInfo.hackerId,r=document.querySelector(`[hacker-id="${o}"]`);r&&(r.style.display==="none"?r.style.display=a.displayInfo[o]:r.style.display="none")}hackerNodeAttributeUpdate(e){const n=e.payload,o=document.querySelector(`[hacker-id="${n.hackerId}"]`);o&&Object.keys(n).forEach(i=>{o.setAttribute(i,n[i])}),E()}hackerNodeStyleUpdate(e){try{const n=e.payload,o=document.querySelector(`[hacker-id="${n.hackerId}"]`);o&&(Object.keys(n).forEach(i=>{const s=i.replace(/([A-Z])/g,"-$1").toLowerCase();CSS.supports(s,n[i])?o.style.setProperty(s,n[i],"important"):console.warn(`属性 ${s} 不在CSS properties中`)}),Le(o,`[hacker-id="${n.hackerId}"]`),E())}catch(n){console.error(n)}}hackerRedo(e){y.redo()}hackerUndo(e){y.undo()}hackerSave(e){l("hacker-save",L())}hackerNodeReplace(e){try{const n=e.payload,o=a.currentNode;if(!o){l("hacker-notify","请先选择一个节点作为参照");return}const r=n.doc,i=n.position||"replace",c=new DOMParser().parseFromString(r,"text/html").querySelector('[component-content="1"]');c.querySelectorAll("img[src]").forEach(A=>{const u=A.getAttribute("src");u.startsWith(F)&&A.setAttribute("src",`http://127.0.0.1:3030/static/${u.replace(F,"")}`)}),a.nodes.push(c),Array.from(c.querySelectorAll("*")).forEach(A=>{const u=A;u.tagName.toLowerCase()!=="noscript"&&u.getAttribute("operation")==null&&u!==a.operationContainer&&(u.shadowRoot!==null&&K(u,u.shadowRoot),u.setAttribute("hacker-id",N()),a.borderInfo[u.getAttribute("hacker-id")]=getComputedStyle(u).getPropertyValue("border"),a.displayInfo[u.getAttribute("hacker-id")]=getComputedStyle(u).display,u.addEventListener("click",w),u.addEventListener("mouseenter",C),u.addEventListener("dragover",$),u.addEventListener("drop",q),u.addEventListener("dragenter",P),u.style.pointerEvents="auto",a.nodes.push(u))});const h=N();c.setAttribute("hacker-id",h),c.addEventListener("click",w),c.addEventListener("mouseenter",C),c.addEventListener("dragover",$),c.addEventListener("drop",q),c.addEventListener("dragenter",P),c.style.pointerEvents="none",a.displayInfo[h]=getComputedStyle(c).display,a.borderInfo[h]=getComputedStyle(c).border;const m=o.nextElementSibling,x=o.previousElementSibling,b=o.parentElement,te={originalNode:o.cloneNode(!0),originalNodeId:o.getAttribute("hacker-id"),nextSubilingNodeId:m?m.getAttribute("hacker-id"):null,previousSubilingNodeId:x?x.getAttribute("hacker-id"):null,parentNodeId:b.getAttribute("hacker-id"),position:i,componentNode:c.cloneNode(!0)},W=k(h,"spawn",{undo:{originNode:o.cloneNode(!0),position:i,componentNode:c}});i==="replace"?(a.nodes.splice(a.nodes.indexOf(o),1),o.replaceWith(c)):i==="before"?b.insertBefore(c,o):i==="after"&&b.insertBefore(c,o.nextSibling),W.operation.meta.redo=te,y.push(W),E(),l("update",{}),c.click()}catch(n){l("hacker-notify","自动选择失败，请手动选择 "+n)}}hackerLayerNodeClick(e){var i;const o=e.payload.hackerId,r=document.querySelector(`[hacker-id="${o}"]`);r&&((i=a.currentNode)==null||i.removeAttribute("contenteditable"),a.currentNode=r,a.currentNode.click())}hackerLayerNodeDelete(e){const o=e.payload.hackerId,r=document.querySelector(`[hacker-id="${o}"]`);r&&(a.currentNode=r,B.delete(),I())}hackerPageSpawn(e){try{const o=e.payload.componentList;console.log("receive component list: ",o);const r=[];if(!o)return alert("获取组件列表失败");if(!a.currentNode)return alert("未找到当前节点");o.forEach(i=>{const s=document.documentElement.cloneNode(!0);s.querySelectorAll('[system="1"]').forEach(d=>{d.remove()});const c=s.querySelector(`[hacker-id="${a.currentNode.getAttribute("hacker-id")}"`);if(c){for(;c.firstChild;)c.removeChild(c.firstChild);const d=new DOMParser().parseFromString(i.content,"text/html");console.log("component doc: ",d.documentElement.outerHTML);const h=d.querySelector('[component-content="1"]');c.appendChild(h),r.push({page:i.page,title:i.title,content:s.outerHTML})}}),l("hacker-page-spawned",{pageList:r})}catch(n){console.log("生成失败",n),alert(n.message)}}hackerToggleOutline(e){const n=a.nodes;try{for(let o=0;o<n.length;o++){const r=n[o],i=r.getAttribute("hacker-id");r.style.border!==j?r.style.border=j:r.style.border=a.borderInfo[i]}}catch(o){alert("发生错误: "+o)}}hackerTranslate(e){const n=e.payload;let o=0;const r=n.text,i=a.currentNode,s=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,G);for(;s.nextNode();){const d=s.currentNode,h=d.nodeValue;h&&h.trim()&&(d.nodeValue=r[o],o++)}let c=Array.from(i.querySelectorAll("input"));c=c.filter(d=>d.type!="hidden"),c.forEach(d=>{const h=d.getAttribute("placeholder");h&&h.trim()&&(d.setAttribute("placeholder",r[o]),o++)}),R(),l("hacker-translate-complete",{doc:L()})}hackerTranslateStart(e){const n=document.querySelector('[component-content="1"]');if(n){n.click();const o=O(a.currentNode);l("hacker-component-translate",{text:o})}else alert("未找到组件节点")}hackerUpdate(e){var n;(n=a.currentNode)==null||n.click()}}let H=!0;const $e={left:Z,right:Q,top:qe,bottom:Pe,center:Re};function Pe(t,e){Q(t,e)}function qe(t,e){Z(t,e)}function Z(t,e){e.parentNode&&(e.parentNode.insertBefore(t,e),t.focus())}function Q(t,e){if(!e.parentNode)return;const n=e.nextSibling;n?e.parentNode.insertBefore(t,n):e.parentNode.appendChild(t),t.focus()}function Re(t,e){e.appendChild(t),t.focus()}function Me(t){!a.currentNode||a.insertPosition==="none"||(a.currentNode.removeAttribute("contenteditable"),$e[a.insertPosition](a.currentNode,t),R(),E())}function ee(t){console.log("dragging",a.currentDragEnterNode),t||setTimeout(()=>{ee(H)},50)}function Oe(t){console.log("drag start"),H=!1,ee(!1)}function Be(t){console.log("drag end"),H=!0;const e=a.dragLine;if(e.style.top="0",e.style.left="0",e.style.width="0",e.style.height="0",e.style.border="none",a.currentDragEnterNode){const n=a.currentNode;let o=n.parentElement,r=n.nextElementSibling,i=n.previousElementSibling;const s=k(n.getAttribute("hacker-id"),"move",{undo:{node:n,parentNodeId:o.getAttribute("hacker-id"),nextSiblingId:r==null?void 0:r.getAttribute("hacker-id"),previousSiblingId:i==null?void 0:i.getAttribute("hacker-id"),single:r===null&&i===null}});Me(a.currentDragEnterNode),o=n.parentElement,r=n.nextElementSibling,i=n.previousElementSibling,s.operation.meta.redo={node:n,parentNodeId:o.getAttribute("hacker-id"),nextSiblingId:r==null?void 0:r.getAttribute("hacker-id"),previousSiblingId:i==null?void 0:i.getAttribute("hacker-id"),single:r===null&&i===null},y.push(s)}a.currentDragEnterNode=null}function He(t){if(console.log("dragging first"),!a.currentDragEnterNode)return;console.log("dragging");const e=a.dragLine;e.style.display="block";const n=a.currentDragEnterNode,o=t.clientX,r=t.clientY,i=n.getBoundingClientRect(),s=o-i.left,c=r-i.top,d=.75,h=s<(1-d)*n.offsetWidth,m=s>d*n.offsetWidth,x=c<(1-d)*n.offsetHeight,b=c>d*n.offsetHeight;e.style.border="none",e.style.backgroundColor="skyblue",h?(e.style.left=`${i.left-1}px`,e.style.top=`${i.top-1}px`,e.style.width="2px",e.style.height=`${i.height}px`,a.insertPosition="left"):m?(e.style.left=`${i.right}px`,e.style.top=`${i.top-1}px`,e.style.width="2px",e.style.height=`${i.height}px`,a.insertPosition="right"):x?(e.style.left=`${i.left-1}px`,e.style.top=`${i.top-1}px`,e.style.width=`${i.width}px`,e.style.height="2px",a.insertPosition="top"):b?(e.style.left=`${i.left-1}px`,e.style.top=`${i.bottom}px`,e.style.width=`${i.width}px`,e.style.height="2px",a.insertPosition="bottom"):(a.insertPosition="center",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.left=i.left+"px",e.style.top=i.top+"px",e.style.width=i.width+"px",e.style.height=i.height+"px",e.style.border=Math.min(Math.min(i.width,i.height)*.1,10)+"px dashed skyblue")}function We(){const t=a.dragLine;t.style.zIndex="999999",document.body.appendChild(a.dragLine);const e=a.menu.filter(n=>n.key==="drag")[0];e.element.draggable=!0,e.element.addEventListener("dragstart",Oe),e.element.addEventListener("dragend",Be),e.element.addEventListener("drag",He),a.nodes.forEach(n=>{n.tagName==="BODY"||n.tagName==="HTML"||n.offsetWidth===0||n.offsetHeight===0||(n.addEventListener("dragover",$),n.addEventListener("dragenter",P),n.addEventListener("drop",q))})}function Ue(t){document.execCommand("insertText",!1,t)}function ze(){window.addEventListener("paste",t=>{t.preventDefault();const e=t.clipboardData.getData("text/plain");Ue(e)})}class Ve{constructor(){Array.from(document.querySelector("body").querySelectorAll("*")).forEach(o=>{o.tagName.toLowerCase()!=="noscript"&&(o.shadowRoot!=null?K(o,o.shadowRoot):(o.getAttribute("hacker-id")==null&&o.setAttribute("hacker-id",N()),a.borderInfo[o.getAttribute("hacker-id")]=getComputedStyle(o).getPropertyValue("border"),a.displayInfo[o.getAttribute("hacker-id")]=getComputedStyle(o).display,a.nodes.push(o)))});const n=document.querySelector("body");n.setAttribute("hacker-id",N()),a.nodes.push(n)}initOperationPanel(){a.menu.forEach(e=>{e.element.style.backgroundImage=`url(${e.icon})`,e.element.style.backgroundSize="cover",e.element.style.backgroundRepeat="no-repeat",e.element.style.backgroundPosition="center",e.element.style.width="15px",e.element.style.height="15px",e.element.setAttribute("operation",e.key),a.operationContainer.appendChild(e.element)}),document.body.appendChild(a.operationContainer)}queryTranslate(){const e=Array.from(document.querySelectorAll("input")),n=O(a.currentNode);for(let o=0;o<e.length;o++){const i=e[o].getAttribute("placeholder");i&&i.trim()&&n.push(i)}l("hacker-component-translate",{text:n})}setup(){new De,this.initOperationPanel(),le(),ue(),We(),ze();const e=document.querySelector('[component-content="1"]');e&&setTimeout(()=>{e.click(),this.queryTranslate()},100);const n=document.querySelector("[hackerMark='true']");n&&(n.click(),l("hacker-auto-spawn",null),n.removeAttribute("hackerMark"))}}(function(){window.addEventListener("DOMContentLoaded",()=>{new Ve().setup(),document.addEventListener("mouseleave",e=>{U()}),U(),l("hacker-loaded",{})})})();
