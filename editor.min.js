var re=Object.defineProperty;var ie=(t,e,o)=>e in t?re(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var w=(t,e,o)=>ie(t,typeof e!="symbol"?e+"":e,o);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=o(r);fetch(r.href,i)}})();const h=(t,e)=>{const o=document.createElement(t);return Object.keys(e).forEach(n=>{o.setAttribute(n,e[n])}),o},b="http://127.0.0.1:3030/assets/",se="0.1px dashed rgb(85, 149, 221)",s={currentNode:null,nodes:[],observer:{currentNode:null,currentHoverNode:null},currentHoverNode:null,borderInfo:{},currentDragEnterNode:null,displayInfo:{},insertPosition:"none",excludeTags:["script","style","meta","link"],hoverTipContainer:h("div",{system:"1",style:"pointer-events: none; position: absolute;"}),selectedTipContainer:h("div",{system:"1",style:"pointer-events: none; position: absolute;"}),operationContainer:h("div",{system:"1",class:"flex",style:"position: absolute; gap: 5px; padding: 5px; background-color: #38bdf8; cursor: pointer; "}),hoverNodeNameTipContainer:h("div",{system:"1",style:"padding-left: 10px; padding-right: 10px; background-color: #38bdf8; color: white; pointer-events: none; position: absolute;"}),selectedNodeNameTipContainer:h("div",{system:"1",style:"padding-left: 10px; padding-right: 10px; background-color: #f87171; color: white; pointer-events: none; position: absolute; z-index: 1000;"}),dragLine:h("div",{system:"1",style:"position: fixed; left: 0; top: 0; pointer-events: none; background-color: #f87171;"}),menu:[{icon:b+"icons/up.png",key:"up",element:h("div",{system:"1"})},{icon:b+"icons/down.png",key:"down",element:h("div",{system:"1"})},{icon:b+"icons/underline.png",key:"underline",element:h("div",{system:"1"})},{icon:b+"icons/italic.png",key:"italic",element:h("div",{system:"1"})},{icon:b+"icons/bold.png",key:"bold",element:h("div",{system:"1"})},{icon:b+"icons/strikethrough.png",key:"strikethrough",element:h("div",{system:"1"})},{icon:b+"icons/drag.png",key:"drag",element:h("div",{system:"1"})},{icon:b+"icons/copy.png",key:"copy",element:h("div",{system:"1"})},{icon:b+"icons/translate.png",key:"translate",element:h("div",{system:"1"})},{icon:b+"icons/export.png",key:"export",element:h("div",{system:"1"})},{icon:b+"icons/delete.png",key:"delete",element:h("div",{system:"1"})}],markedNodes:new Map,markedList:[],topParent:null};function l(t,e){window.parent.postMessage({type:t,data:e},"*")}function E(){l("hacker-un-save",{})}function M(){s.hoverTipContainer.style.display="none",s.selectedTipContainer.style.display="none",s.hoverNodeNameTipContainer.style.display="none",s.selectedNodeNameTipContainer.style.display="none",s.dragLine.style.display="none",s.operationContainer.style.opacity="0"}function U(){s.hoverTipContainer.style.display="none",s.hoverNodeNameTipContainer.style.display="none",s.operationContainer.style.display="none"}function ae(t){const e=getComputedStyle(t),o=i=>i.replace(/-([a-z])/g,(c,a)=>a.toUpperCase()),n={};for(let i of e){const c=o(i);n[c]=e.getPropertyValue(i)}const r={...n,hackerId:t.getAttribute("hacker-id"),hackerMark:t.getAttribute("data-hacker-mark")||!1,id:t.getAttribute("id"),src:t.getAttribute("src"),href:t.getAttribute("href"),target:t.getAttribute("data-target")||"none",placeholder:t.getAttribute("placeholder"),name:t.getAttribute("name"),type:t.getAttribute("type"),classList:t.className,hoverClass:t.getAttribute("data-hover-class")||"",disabledClass:t.getAttribute("data-disabled-class")||"",classType:typeof t.className,tagName:t.tagName.toLowerCase(),height:t.style.height||t.offsetHeight,width:t.style.width||t.offsetWidth,text:t.innerText,srcset:t.getAttribute("srcset"),borderRadius:e.borderRadius,borderStyle:e.borderStyle,borderWidth:e.borderWidth,borderColor:e.borderColor,backgroundColor:e.backgroundColor,triggerTiming:t.getAttribute("data-trigger-timing")||"none",triggerType:t.getAttribute("data-trigger-type")||"system",triggerCode:t.getAttribute("data-trigger-code")||"",triggerEvent:t.getAttribute("data-trigger-event")||"none",targetState:t.getAttribute("data-target-state")||"default",targetId:t.getAttribute("data-target-id")||"",targetLink:t.getAttribute("data-target-link")||"",macroId:t.getAttribute("data-macro-id")||"",macroValue:t.getAttribute("data-macro-value")||"",disabled:t.getAttribute("data-disabled")||"false"};if((t.tagName.toLowerCase()==="input"||t.tagName.toLowerCase()==="textarea")&&Object.assign(r,{sensitive:t.getAttribute("data-sensitive")||"",alias:t.getAttribute("data-alias")||t.getAttribute("name"),mode:t.getAttribute("data-mode")||"system",rule:t.getAttribute("data-rule")||"none",msg:t.getAttribute("data-msg")||"",required:t.getAttribute("required")||"false",user:t.getAttribute("data-user")||"",minLength:t.getAttribute("minlength")||"",maxLength:t.getAttribute("maxlength")||""}),t.tagName.toLowerCase()==="select"){const i=t,c=Array.from(i.options).map(a=>({value:a.value,text:a.text,selected:a.selected}));Object.assign(r,{options:c,user:i.getAttribute("data-user")||"",sensitive:i.getAttribute("data-sensitive")||"",alias:i.getAttribute("data-alias")||i.getAttribute("name")})}l("hacker-node-info",r)}const y=[];for(let t=0;t<256;++t)y.push((t+256).toString(16).slice(1));function ce(t,e=0){return(y[t[e+0]]+y[t[e+1]]+y[t[e+2]]+y[t[e+3]]+"-"+y[t[e+4]]+y[t[e+5]]+"-"+y[t[e+6]]+y[t[e+7]]+"-"+y[t[e+8]]+y[t[e+9]]+"-"+y[t[e+10]]+y[t[e+11]]+y[t[e+12]]+y[t[e+13]]+y[t[e+14]]+y[t[e+15]]).toLowerCase()}let D;const le=new Uint8Array(16);function de(){if(!D){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");D=crypto.getRandomValues.bind(crypto)}return D(le)}const ue=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),V={randomUUID:ue};function A(t,e,o){var r;if(V.randomUUID&&!t)return V.randomUUID();t=t||{};const n=t.random??((r=t.rng)==null?void 0:r.call(t))??de();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,ce(n)}function K(t,e,o=4,n=4){const{top:r,left:i,width:c,height:a}=t;e.style.top=`${r-o+window.scrollY}px`,e.style.left=`${i-n+window.scrollX}px`,e.style.width=`${c+n*2}px`,e.style.height=`${a+o*2}px`}function G(t,e,o,n=2,r=2){t.innerText=e,t.style.display="block",t.style.left=`${o.left+n+window.scrollX}px`,t.style.top=`${o.top-t.offsetHeight+r+window.scrollY}px`}function I(t){const e=t.target;s.currentHoverNode=e,s.observer.currentHoverNode=e;const o=e.getBoundingClientRect(),n=s.hoverTipContainer;n.style.display="block",K(o,n,2,2),n.style.border="1px dashed #38bdf8";const r=e.tagName.toLowerCase();G(s.hoverNodeNameTipContainer,r,o,-2,-2)}function O(t){t.stopPropagation()}function pe(){s.hoverTipContainer.style.zIndex="99999",s.hoverNodeNameTipContainer.style.zIndex="99999",document.body.appendChild(s.hoverTipContainer),document.body.appendChild(s.hoverNodeNameTipContainer),s.nodes.forEach(t=>{t.addEventListener("mouseenter",I),t.addEventListener("mouseleave",O),t.style.userSelect="none"})}function L(t){const e=t.target;if(e.getAttribute("system")=="1"||s.excludeTags.includes(e.tagName.toLowerCase()))return;s.currentNode!==null&&s.currentNode!==e&&s.currentNode.setAttribute("contenteditable","false"),s.currentNode=e,s.currentNode.tagName.toLowerCase()!="img"&&s.currentNode.setAttribute("contenteditable","true");const o=e.getBoundingClientRect();s.currentHoverNode===e&&I(t),he(o),s.selectedTipContainer.style.border="2px dashed #f87171",s.selectedTipContainer.style.display="block",K(o,s.selectedTipContainer,2,2),G(s.selectedNodeNameTipContainer,e.tagName.toLowerCase(),o,-2,-2),E(),ae(e),(e.closest("a")||e.closest("select"))&&t.preventDefault()}function he(t){const e=s.operationContainer;e.style.display="flex",e.style.opacity="1",e.style.zIndex="999999999",e.style.left=`${t.left+window.scrollX}px`,e.style.top=`${t.bottom+window.scrollY}px`;const o=e.offsetWidth,n=e.offsetHeight,r=window.innerWidth,i=window.innerHeight;e.offsetLeft+o>r&&(e.style.left=`${r-o}px`),Math.ceil(t.top+t.height)>=i&&(e.style.top=`${i-n+window.scrollY}px`)}function ye(){s.selectedTipContainer.style.zIndex="99999",document.body.appendChild(s.selectedTipContainer),document.body.appendChild(s.selectedNodeNameTipContainer),s.nodes.forEach(t=>{t.addEventListener("click",L),t.tagName.toLocaleLowerCase()=="select"&&t.addEventListener("mousedown",e=>e.preventDefault()),t.style.userSelect="none"}),s.menu.forEach(t=>{t.key!=="drag"&&(t.element.onclick=e=>De(t.key,null))})}function _(t){t.setAttribute("hacker-id",A()),s.nodes.push(t),t.onmouseleave=O,t.onclick=L,t.onmouseenter=I,l("update",{})}function ge(){}const fe=["script","style","noscript","meta","link","head"];function j(t){return t.split("-").map((e,o)=>o===0?e:e.charAt(0).toUpperCase()+e.slice(1)).join("")}function J(t,e){const o=r=>{r.shadowRoot&&n(r,r.shadowRoot),r.setAttribute("shadow","1"),r.onclick=i=>{i.preventDefault(),s.currentNode=r},r.setAttribute("hacker-id",A()),s.nodes.push(r),s.borderInfo[r.getAttribute("hacker-id")]=getComputedStyle(r).border;for(let i=0;i<r.children.length;i++)o(r.children[i])},n=(r,i)=>{for(let c=0;c<i.children.length;c++){const a=i.children[c];o(a)}r.addEventListener("scroll",ge)};n(t,e)}function B(t){const e=[],o=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,Z);for(;o.nextNode();){const r=o.currentNode.nodeValue;r&&r.trim()&&e.push(r)}return e}const Z={acceptNode(t){var e;return(e=t.parentElement)!=null&&e.tagName.match(/^(SCRIPT|STYLE|CODE)$/i)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}};function z(t=!1){const e=document.documentElement.cloneNode(!0);return e.querySelectorAll("*").forEach(n=>{const r=n;r.style.border===se&&(r.style.border=s.borderInfo[r.getAttribute("hacker-id")])}),e.querySelectorAll('[system="1"]').forEach(n=>{n.remove()}),t&&e.querySelectorAll('[kernel="inject"]').forEach(n=>{n.remove()}),e.outerHTML}const me=t=>{t.addEventListener("click",L),t.addEventListener("mouseenter",I),t.addEventListener("mouseleave",O),t.setAttribute("hacker-id",A()),s.nodes.push(t)},Q=t=>{const e=[];return Array.from(t.children).forEach(n=>{n instanceof HTMLElement&&(e.push(n),e.push(...Q(n)))}),e},T=t=>{const e=document.body;if(!e)return console.error("未找到指定的容器元素"),null;function o(r,i=0,c="0"){if(!r||r.nodeType===Node.COMMENT_NODE||r.nodeType===Node.TEXT_NODE||r.tagName.toLowerCase()==="noscript"||r.attributes===void 0||r.getAttribute("operation")!==null||r.getAttribute("tools")!==null||fe.includes(r.tagName.toLowerCase()))return null;const a={title:r.tagName?r.tagName.toLowerCase():null,attributes:{},children:[],key:c,content:null,hackerId:r.getAttribute("hacker-id")||null};if(r.nodeType===Node.ELEMENT_NODE){for(const p of r.attributes);r.shadowRoot&&Array.from(r.shadowRoot.children).forEach((f,k)=>{const m=o(f,i+1,`${c}-shadow-${k}`);m&&a.children.push(m)})}let d=0;for(const p of r.childNodes){const f=o(p,i+1,`${c}-${d}`);f&&(a.children.push(f),d++)}return r.textContent&&r.textContent.trim()&&a.children.length,a}const n=o(e);l("hacker-layer",n)};function F(t){try{t.querySelectorAll("script").forEach(o=>{try{new Function(o.textContent??"")()}catch(n){console.error("执行脚本失败:",n)}})}catch(e){console.error(e)}}function be(t){const e=ke(t),o=new Set(e);if(s.markedNodes.has(t)){const i=s.markedNodes.get(t);i&&(i.remove(),s.markedNodes.delete(t)),o.forEach(c=>{c.removeAttribute("data-marked"),s.markedNodes.delete(c)});return}const n=h("div",{style:"position: absolute; z-index: 9999; pointer-events: none; border: 2px dashed green; border-radius: 5px;"}),r=t.getBoundingClientRect();n.style.top=`${r.top+window.scrollY}px`,n.style.left=`${r.left+window.scrollX}px`,n.style.width=`${r.width}px`,n.style.height=`${r.height}px`,s.markedNodes.set(t,n),document.body.appendChild(n),o.forEach(i=>{i.setAttribute("data-marked","true")})}function ke(t,e=!1){if(!(t instanceof HTMLElement))throw new Error("输入参数必须是 HTMLElement 类型");const o=new Set([t]);let n=t.parentElement,r=t;for(;n&&(e?n!==document.documentElement:n!==document.body);)o.add(n),r=n,n=n.parentElement;const i=c=>{Array.from(c.children).forEach(d=>{d instanceof HTMLElement&&(o.add(d),i(d))})};if(i(r),s.topParent===null)s.topParent=r;else{const c=s.topParent.getBoundingClientRect();r.getBoundingClientRect().top<c.top&&(s.topParent=r)}return o}function Ne(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`);e&&(s.nodes=s.nodes.filter(o=>o!==e),e.remove())}function Se(t){const e=t.operation.meta.redo,o=e.node,n=document.querySelector(`[hacker-id="${e.parentNodeId}"]`),r=document.querySelector(`[hacker-id="${e.nextSiblingId}"]`);r?n.insertBefore(o,r):n.appendChild(o),g.push(t)}function xe(t){const e=t.operation.meta.undo,o=e.single,n=document.querySelector(`[hacker-id="${e.parentNodeId}"]`);if(o)n.appendChild(e.node);else{const r=e.nextSiblingId,i=e.previousSiblingId,c=document.querySelector(`[hacker-id="${r}"]`),a=document.querySelector(`[hacker-id="${i}"]`);c?n.insertBefore(e.node,c):a&&a.nextElementSibling?n.insertBefore(e.node,a.nextElementSibling):n.appendChild(e.node)}}function ve(t){const o=t.operation.meta.redo.nodeId,n=document.querySelector(`[hacker-id="${o}"]`);n&&(n.click(),H.delete())}function Ce(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.undo,n=document.querySelector(`[hacker-id="${o.parentNodeId}"]`);if(o.single)n.appendChild(e);else{const r=o.nextSiblingId,i=o.previousSiblingId,c=document.querySelector(`[hacker-id="${r}"]`),a=document.querySelector(`[hacker-id="${i}"]`);c?n.insertBefore(e,c):a&&a.nextElementSibling?n.insertBefore(e,a.nextElementSibling):n.appendChild(e)}}function Ee(t){const e=t.operation.meta.redo,o=document.querySelector(`[hacker-id="${e.parentNodeId}"]`),n=document.querySelector(`[hacker-id="${t.hackerId}"]`);if(e.single)o.appendChild(n);else{const r=e.nextSiblingId,i=e.previousSiblingId,c=document.querySelector(`[hacker-id="${r}"]`),a=document.querySelector(`[hacker-id="${i}"]`);c?o.insertBefore(n,c):a&&a.nextElementSibling?o.insertBefore(n,a.nextElementSibling):o.appendChild(n)}g.push(t)}function Ae(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.undo;e?o.position==="replace"?e.replaceWith(o.originNode):o.componentNode.remove():l("hacker-notify","节点丢失，本次操作失败")}function we(t){const e=t.operation.meta.redo,o=document.querySelector(`[hacker-id="${e.parentNodeId}"]`);if(o){const n=e.componentNode,r=e.position,i=document.querySelector(`[hacker-id="${e.originalNodeId}"]`);if(e.originalNode=i.cloneNode(!0),e.componentNode=n.cloneNode(!0),r==="replace")i.replaceWith(n);else if(r==="before")o.insertBefore(n,i);else if(r==="after")o.insertBefore(n,i.nextSibling);else{l("hacker-notify","未定义的操作");return}t.operation.meta.redo={...e},t.operation.meta.undo.componentNode=n,g.push(t)}else l("hacker-notify","父节点丢失，本次操作失败")}function Ie(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.undo;Object.keys(o).forEach(n=>{e.style[n]=o[n]})}function Le(t){const e=document.querySelector(`[hacker-id="${t.hackerId}"]`),o=t.operation.meta.redo;Object.keys(o).forEach(n=>{e.style[n]=o[n]})}const C=class C{constructor(){w(this,"undoStack",[]);w(this,"redoStack",[]);w(this,"maxStackSize",100)}static get Instance(){return C.instance||(C.instance=new C),C.instance}push(e){this.undoStack.length>=this.maxStackSize&&this.undoStack.shift(),this.undoStack.push(e)}pop(e){const o=e==="undo"?this.undoStack:this.redoStack;if(o.length>0){const n=o.pop();return e==="undo"&&this.redoStack.push(n),n}return null}redo(){const e=this.pop("redo");if(e){switch(e.operation.type){case"style":Le(e);break;case"delete":ve(e);break;case"move":Ee(e);break;case"copy":Se(e);break;case"spawn":we(e);break;default:l("hacker-notify","editor.redo.not-supported");break}T()}else l("hacker-notify","editor.redo.none")}undo(){const e=this.pop("undo");if(e){switch(e.operation.type){case"style":Ie(e);break;case"delete":xe(e);break;case"move":Ce(e);break;case"copy":Ne(e);break;case"spawn":Ae(e);break;default:l("hacker-notify","editor.undo.not-supported");break}T()}else l("hacker-notify","editor.undo.none")}};w(C,"instance");let $=C;const g=$.Instance;function v(t,e,o){return{hackerId:t,operation:{type:e,meta:{undo:{},redo:{},...o}}}}class Te{constructor(){w(this,"metaOrCtrlIsPressed",!1);window.addEventListener("keyup",e=>{(e.key==="Meta"||e.key==="Control")&&(this.metaOrCtrlIsPressed=!1)}),window.addEventListener("keydown",e=>{switch((e.key==="Meta"||e.key==="Control")&&(this.metaOrCtrlIsPressed=!0),e.key){case"ArrowUp":this.up();break;case"ArrowDown":this.down();break;case"Delete":this.delete();break;case"Backspace":{this.metaOrCtrlIsPressed&&this.delete();break}case"z":this.metaOrCtrlIsPressed&&g.undo();break}})}callMethod(e,o){typeof this[e]=="function"?this[e](o):console.warn(`Method ${e} is not defined.`)}copy(){const e=s.currentNode;e.removeAttribute("contenteditable");const o=e.cloneNode(!0);o.setAttribute("contenteditable","false");const n=e.parentElement;if(n){let r=e.nextElementSibling;r?n.insertBefore(o,e.nextSibling):n.appendChild(o),s.currentNode=o,_(o);const i=v(o.getAttribute("hacker-id"),"copy",{undo:{}});o.click(),r=o.nextElementSibling,l("update",{}),Q(o).forEach(c=>{_(c)}),i.operation.meta.redo={node:o.cloneNode(!0),parentNodeId:n.getAttribute("hacker-id"),nextSiblingId:r?r.getAttribute("hacker-id"):null},g.push(i)}else l("hacker-notify","无法复制节点，因为当前节点没有父节点")}delete(){const e=s.currentNode;if(e.tagName.toLowerCase()==="body"||e===document.body||e.tagName.toLowerCase()==="html"){l("hacker-notify","无法删除根节点");return}const o=e.parentElement,n=e.nextElementSibling,r=e.previousElementSibling,i=v(e.getAttribute("hacker-id"),"delete",{undo:{node:e.cloneNode(!0),parentNodeId:o.getAttribute("hacker-id"),nextSiblingId:n?n.getAttribute("hacker-id"):null,previousSiblingId:r?r.getAttribute("hacker-id"):null,single:n===null&&r===null}});s.nodes=s.nodes.filter(c=>c!==e),e.remove(),s.currentNode=null,l("update",{}),l("clearNodeInfo",{}),E(),M(),i.operation.meta.redo={nodeId:i.hackerId},console.log("delete state: ",i),g.push(i)}up(){const o=s.currentNode.parentNode;o&&o.click()}down(){const e=s.currentNode;if(!e)return;const o=Array.from(e.children);o.length>0&&(s.currentNode=o[0],s.currentNode.click())}underline(){const e=s.currentNode;if(!e)return;const o=e.style.textDecoration,n=v(e.getAttribute("hacker-id"),"style",{undo:{textDecoration:o}});o==="none"||o===""?e.style.textDecoration="underline":e.style.textDecoration="none",n.operation.meta.redo.textDecoration=e.style.textDecoration,g.push(n)}bold(){const e=s.currentNode;if(!e)return;const o=v(e.getAttribute("hacker-id"),"style",{undo:{fontWeight:e.style.fontWeight}}),n=e.style.fontWeight;n==="normal"||n===""?e.style.fontWeight="bold":e.style.fontWeight="normal",o.operation.meta.redo.fontWeight=e.style.fontWeight,g.push(o)}italic(){const e=s.currentNode;if(!e)return;const o=v(e.getAttribute("hacker-id"),"style",{undo:{fontStyle:e.style.fontStyle}}),n=e.style.fontStyle;n==="normal"||n===""?e.style.fontStyle="italic":e.style.fontStyle="normal",o.operation.meta.redo.fontStyle=e.style.fontStyle,g.push(o)}strikethrough(){const e=s.currentNode;if(!e)return;const o=v(e.getAttribute("hacker-id"),"style",{undo:{textDecoration:e.style.textDecoration}}),n=e.style.textDecoration;n==="none"||n===""?e.style.textDecoration="line-through":e.style.textDecoration="none",o.operation.meta.redo.textDecoration=e.style.textDecoration,g.push(o)}translate(){const e=s.currentNode;if(!e)return;const o=B(e);let n=Array.from(e.querySelectorAll("input"));n=n.filter(r=>r.type!=="hidden"),n.forEach(r=>{const i=r.getAttribute("placeholder");i&&i.trim()&&o.push(i)}),l("hacker-translate",{text:o})}export(){const e=s.currentNode.cloneNode(!0),o=[...s.currentNode.querySelectorAll("*"),s.currentNode];e.removeAttribute("contenteditable");const n=e.getAttribute("hacker-id");e.style.border=s.borderInfo[n],e.removeAttribute("hacker-id");const r=Array.from(e.querySelectorAll("*"));r.push(e),r.forEach((c,a)=>{const d={},p=c,f=o[a],k=f.style.cssText.split(";");for(let S=0;S<k.length;S++){const x=k[S].trim();if(x){const[N,u]=x.split(":");N&&u&&(d[N.trim()]=u.trim())}}const m=getComputedStyle(f);for(let S of m){const x=S.replace(/([A-Z])/g,"-$1").toLowerCase(),N=m.getPropertyValue(S);d[x]||p.style.setProperty(x,N)}p.onclick=null,p.removeAttribute("contenteditable")}),e.setAttribute("component-content","1"),e.removeAttribute("contenteditable");const i=document.createElement("div");i.style.setProperty("width","100%"),i.style.setProperty("height","100%"),i.style.setProperty("display","flex"),i.style.setProperty("justify-content","center"),i.style.setProperty("align-items","center"),i.style.setProperty("position","relative"),i.style.setProperty("padding","15px"),i.appendChild(e),l("hacker-export",i.outerHTML)}mark(){const e=s.currentNode;e&&be(e)}code(){const e=["script","style"];s.nodes.forEach(r=>{r.getAttribute("data-marked")==="true"||r===document.body||e.includes(r.tagName.toLowerCase())||r.remove()});const n=h("div",{style:"height: auto; width: 100%;important; position: relative; padding: 15px;"});me(n),s.topParent.parentNode.insertBefore(n,s.topParent.nextSibling),n.click(),l("hacker-auto-mark",null)}}const H=new Te;function De(t,e){H.callMethod(t,e)}function P(t){t.preventDefault()}function q(t){s.currentDragEnterNode=t.target}function R(t){t.preventDefault()}const Y="0.1px dashed rgb(85, 149, 221)",X="http://196.251.85.59/assets";function $e(t){const e=t.style;let o="";for(let n=0;n<e.length;n++){const r=e[n],i=e.getPropertyValue(r),c=e.getPropertyPriority(r);o+=`${r}: ${i}${c?" !important":""}; `}return o.trim()}function Pe(t,e){const o=$e(t);if(o){let n=document.querySelector("style#dynamic-styles");n||(n=document.createElement("style"),n.id="dynamic-styles",document.head.appendChild(n));const r=`${e} { ${o} }`;n.textContent+=r+`
`}}class qe{constructor(){window.addEventListener("message",this.handleMessage.bind(this)),T()}handleMessage(e){if(e.data.type&&e.data.type&&e.data.type.startsWith("hacker")){const{type:o}=e.data;this.callMethod(o,e.data)}}callMethod(e,o){if(typeof this[j(e)]=="function")try{this[j(e)](o)}catch(n){alert(n.message)}else console.warn(`Method ${e} is not defined.`)}hackerToggleDisplay(e){const n=e.payload.payload.nodeInfo.hackerId,r=document.querySelector(`[hacker-id="${n}"]`);r&&(r.style.display==="none"?r.style.display=s.displayInfo[n]:r.style.display="none")}hackerNodeAttributeUpdate(e){const o=e.payload,n=document.querySelector(`[hacker-id="${o.hackerId}"]`);n&&Object.keys(o).forEach(i=>{n.setAttribute(i,o[i])}),E()}hackerNodeStyleUpdate(e){try{const o=e.payload,n=document.querySelector(`[hacker-id="${o.hackerId}"]`);n&&(Object.keys(o).forEach(i=>{const c=i.replace(/([A-Z])/g,"-$1").toLowerCase();CSS.supports(c,o[i])?n.style.setProperty(c,o[i],"important"):console.warn(`属性 ${c} 不在CSS properties中`)}),Pe(n,`[hacker-id="${o.hackerId}"]`),E())}catch(o){console.error(o)}}hackerRedo(e){g.redo()}hackerUndo(e){g.undo()}hackerSave(e){l("hacker-save",z())}hackerNodeReplace(e){try{const o=e.payload,n=s.currentNode;if(!n){l("hacker-notify","请先选择一个节点作为参照");return}const r=o.doc,i=o.position||"replace",a=new DOMParser().parseFromString(r,"text/html").querySelector('[component-content="1"]');a.querySelectorAll("img[src]").forEach(N=>{const u=N.getAttribute("src");u.startsWith(X)&&N.setAttribute("src",`http://127.0.0.1:3030/static/${u.replace(X,"")}`)}),s.nodes.push(a),Array.from(a.querySelectorAll("*")).forEach(N=>{const u=N;u.tagName.toLowerCase()!=="noscript"&&u.getAttribute("operation")==null&&u!==s.operationContainer&&(u.shadowRoot!==null&&J(u,u.shadowRoot),u.setAttribute("hacker-id",A()),s.borderInfo[u.getAttribute("hacker-id")]=getComputedStyle(u).getPropertyValue("border"),s.displayInfo[u.getAttribute("hacker-id")]=getComputedStyle(u).display,u.addEventListener("click",L),u.tagName.toLowerCase()==="select"&&u.addEventListener("mousedown",ne=>ne.preventDefault()),u.addEventListener("mouseenter",I),u.addEventListener("dragover",P),u.addEventListener("drop",R),u.addEventListener("dragenter",q),u.style.pointerEvents="auto",s.nodes.push(u))});const p=A();a.setAttribute("hacker-id",p),a.addEventListener("click",L),a.addEventListener("mouseenter",I),a.addEventListener("dragover",P),a.addEventListener("drop",R),a.addEventListener("dragenter",q),a.style.pointerEvents="none",s.displayInfo[p]=getComputedStyle(a).display,s.borderInfo[p]=getComputedStyle(a).border;const f=n.nextElementSibling,k=n.previousElementSibling,m=n.parentElement,S={originalNode:n.cloneNode(!0),originalNodeId:n.getAttribute("hacker-id"),nextSubilingNodeId:f?f.getAttribute("hacker-id"):null,previousSubilingNodeId:k?k.getAttribute("hacker-id"):null,parentNodeId:m.getAttribute("hacker-id"),position:i,componentNode:a.cloneNode(!0)},x=v(p,"spawn",{undo:{originNode:n.cloneNode(!0),position:i,componentNode:a}});i==="replace"?(s.nodes.splice(s.nodes.indexOf(n),1),n.replaceWith(a)):i==="before"?m.insertBefore(a,n):i==="after"&&m.insertBefore(a,n.nextSibling),x.operation.meta.redo=S,g.push(x),E(),l("update",{}),F(a),a.click()}catch(o){l("hacker-notify","自动选择失败，请手动选择 "+o)}}hackerLayerNodeClick(e){var i;const n=e.payload.hackerId,r=document.querySelector(`[hacker-id="${n}"]`);r&&((i=s.currentNode)==null||i.removeAttribute("contenteditable"),s.currentNode=r,s.currentNode.click())}hackerLayerNodeDelete(e){const n=e.payload.hackerId,r=document.querySelector(`[hacker-id="${n}"]`);r&&(s.currentNode=r,H.delete(),T())}hackerPageSpawn(e){try{const n=e.payload.componentList;console.log("receive component list: ",n);const r=[];if(!n)return alert("获取组件列表失败");if(!s.currentNode)return alert("未找到当前节点");n.forEach(i=>{const c=document.documentElement.cloneNode(!0);c.querySelectorAll('[system="1"]').forEach(d=>{d.remove()});const a=c.querySelector(`[hacker-id="${s.currentNode.getAttribute("hacker-id")}"`);if(a){for(;a.firstChild;)a.removeChild(a.firstChild);const p=new DOMParser().parseFromString(i.content,"text/html").querySelector('[component-content="1"]');F(p),a.appendChild(p),r.push({page:i.page,title:i.title,content:c.outerHTML})}}),l("hacker-page-spawned",{pageList:r})}catch(o){console.log("生成失败",o),alert(o.message)}}hackerToggleOutline(e){const o=s.nodes;try{for(let n=0;n<o.length;n++){const r=o[n],i=r.getAttribute("hacker-id");r.style.border!==Y?r.style.border=Y:r.style.border=s.borderInfo[i]}}catch(n){alert("发生错误: "+n)}}hackerTranslate(e){const o=e.payload;let n=0;const r=o.text,i=s.currentNode,c=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,Z);for(;c.nextNode();){const d=c.currentNode,p=d.nodeValue;p&&p.trim()&&(d.nodeValue=r[n],n++)}let a=Array.from(i.querySelectorAll("input"));a=a.filter(d=>d.type!="hidden"),a.forEach(d=>{const p=d.getAttribute("placeholder");p&&p.trim()&&(d.setAttribute("placeholder",r[n]),n++)}),M(),l("hacker-translate-complete",{doc:z()})}hackerSelectOptionsUpdate(e){const o=e.payload,n=o.options,r=o.hackerId;console.log("options: ",n),console.log("hackerId: ",r);const i=document.querySelector(`[hacker-id="${r}"]`);if(i){for(;i.firstChild;)i.removeChild(i.firstChild);n.forEach(c=>{const a=document.createElement("option");a.value=c.value,a.text=c.text,c.selected&&(a.selected=!0),i.add(a)}),E()}}hackerTranslateStart(e){const o=document.querySelector('[component-content="1"]');if(o){o.click();const n=B(s.currentNode);l("hacker-component-translate",{text:n})}else alert("未找到组件节点")}hackerUpdate(e){var o;(o=s.currentNode)==null||o.click()}}let W=!0;const Re={left:ee,right:te,top:Oe,bottom:Me,center:Be};function Me(t,e){te(t,e)}function Oe(t,e){ee(t,e)}function ee(t,e){e.parentNode&&(e.parentNode.insertBefore(t,e),t.focus())}function te(t,e){if(!e.parentNode)return;const o=e.nextSibling;o?e.parentNode.insertBefore(t,o):e.parentNode.appendChild(t),t.focus()}function Be(t,e){e.appendChild(t),t.focus()}function He(t){!s.currentNode||s.insertPosition==="none"||(s.currentNode.removeAttribute("contenteditable"),Re[s.insertPosition](s.currentNode,t),M(),E())}function oe(t){console.log("dragging",s.currentDragEnterNode),t||setTimeout(()=>{oe(W)},50)}function We(t){console.log("drag start"),W=!1,oe(!1)}function Ue(t){console.log("drag end"),W=!0;const e=s.dragLine;if(e.style.top="0",e.style.left="0",e.style.width="0",e.style.height="0",e.style.border="none",s.currentDragEnterNode){const o=s.currentNode;let n=o.parentElement,r=o.nextElementSibling,i=o.previousElementSibling;const c=v(o.getAttribute("hacker-id"),"move",{undo:{node:o,parentNodeId:n.getAttribute("hacker-id"),nextSiblingId:r==null?void 0:r.getAttribute("hacker-id"),previousSiblingId:i==null?void 0:i.getAttribute("hacker-id"),single:r===null&&i===null}});He(s.currentDragEnterNode),n=o.parentElement,r=o.nextElementSibling,i=o.previousElementSibling,c.operation.meta.redo={node:o,parentNodeId:n.getAttribute("hacker-id"),nextSiblingId:r==null?void 0:r.getAttribute("hacker-id"),previousSiblingId:i==null?void 0:i.getAttribute("hacker-id"),single:r===null&&i===null},g.push(c)}s.currentDragEnterNode=null}function Ve(t){if(console.log("dragging first"),!s.currentDragEnterNode)return;console.log("dragging");const e=s.dragLine;e.style.display="block";const o=s.currentDragEnterNode,n=t.clientX,r=t.clientY,i=o.getBoundingClientRect(),c=n-i.left,a=r-i.top,d=.75,p=c<(1-d)*o.offsetWidth,f=c>d*o.offsetWidth,k=a<(1-d)*o.offsetHeight,m=a>d*o.offsetHeight;e.style.border="none",e.style.backgroundColor="skyblue",p?(e.style.left=`${i.left-1}px`,e.style.top=`${i.top-1}px`,e.style.width="2px",e.style.height=`${i.height}px`,s.insertPosition="left"):f?(e.style.left=`${i.right}px`,e.style.top=`${i.top-1}px`,e.style.width="2px",e.style.height=`${i.height}px`,s.insertPosition="right"):k?(e.style.left=`${i.left-1}px`,e.style.top=`${i.top-1}px`,e.style.width=`${i.width}px`,e.style.height="2px",s.insertPosition="top"):m?(e.style.left=`${i.left-1}px`,e.style.top=`${i.bottom}px`,e.style.width=`${i.width}px`,e.style.height="2px",s.insertPosition="bottom"):(s.insertPosition="center",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.left=i.left+"px",e.style.top=i.top+"px",e.style.width=i.width+"px",e.style.height=i.height+"px",e.style.border=Math.min(Math.min(i.width,i.height)*.1,10)+"px dashed skyblue")}function _e(){const t=s.dragLine;t.style.zIndex="999999",document.body.appendChild(s.dragLine);const e=s.menu.filter(o=>o.key==="drag")[0];e.element.draggable=!0,e.element.addEventListener("dragstart",We),e.element.addEventListener("dragend",Ue),e.element.addEventListener("drag",Ve),s.nodes.forEach(o=>{o.tagName==="BODY"||o.tagName==="HTML"||o.offsetWidth===0||o.offsetHeight===0||(o.addEventListener("dragover",P),o.addEventListener("dragenter",q),o.addEventListener("drop",R))})}function je(t){document.execCommand("insertText",!1,t)}function ze(){window.addEventListener("paste",t=>{t.preventDefault();const e=t.clipboardData.getData("text/plain");je(e)})}class Fe{constructor(){Array.from(document.querySelector("body").querySelectorAll("*")).forEach(n=>{n.tagName.toLowerCase()!=="noscript"&&(n.shadowRoot!=null?J(n,n.shadowRoot):(n.getAttribute("hacker-id")==null&&n.setAttribute("hacker-id",A()),s.borderInfo[n.getAttribute("hacker-id")]=getComputedStyle(n).getPropertyValue("border"),s.displayInfo[n.getAttribute("hacker-id")]=getComputedStyle(n).display,s.nodes.push(n)))});const o=document.querySelector("body");o.setAttribute("hacker-id",A()),s.nodes.push(o)}initOperationPanel(){s.menu.forEach(e=>{e.element.style.backgroundImage=`url(${e.icon})`,e.element.style.backgroundSize="cover",e.element.style.backgroundRepeat="no-repeat",e.element.style.backgroundPosition="center",e.element.style.width="15px",e.element.style.height="15px",e.element.setAttribute("operation",e.key),s.operationContainer.appendChild(e.element)}),document.body.appendChild(s.operationContainer)}queryTranslate(){const e=Array.from(document.querySelectorAll("input")),o=B(s.currentNode);for(let n=0;n<e.length;n++){const i=e[n].getAttribute("placeholder");i&&i.trim()&&o.push(i)}l("hacker-component-translate",{text:o})}setup(){new qe,this.initOperationPanel(),pe(),ye(),_e(),ze();const e=document.querySelector('[component-content="1"]');e&&setTimeout(()=>{e.click(),this.queryTranslate()},500);const o=document.querySelector("[hackerMark='true']");o&&(o.click(),l("hacker-auto-spawn",null),o.removeAttribute("hackerMark"))}}(function(){window.addEventListener("DOMContentLoaded",()=>{new Fe().setup(),document.addEventListener("mouseleave",e=>{U()}),U(),l("hacker-loaded",{})})})();
